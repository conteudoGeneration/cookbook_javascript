<h1>Teste de Software - Jest - Configurando o Ambiente</h1>

<br />

<h2>üë£ Passo 01 - Instalar o SuperTest</h2>



Vamos instalar a Biblioteca SuperTest atrav√©s do NPM.

1. Abra o **Terminal** do VSCode atrav√©s do menu **Terminal ü°™ New Terminal**
2. Para instalar o **SupeTest**, digite o comando abaixo:

```bash
npm install --save-dev supertest
```

3. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/t5t1DeK.png?1" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 02 - Instalar o Banco de dados SQLite</h2>



Vamos instalar o Banco de Dados SQLite atrav√©s do NPM.

1. Abra o **Terminal** do VSCode atrav√©s do menu **Terminal ü°™ New Terminal**
2. Para instalar o **SQLite**, digite o comando abaixo:

```bash
npm install sqlite3
```

3. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/aRKvO3N.png" title="source: imgur.com" /></div>

<br />

<h2 >üë£ Passo 03 - Configurar o Banco de dados</h2>



Todos os testes do **M√≥dulo Usuario** ser√£o escritos na Classe de Testes **app.e2e-spec.ts**. A grande vantagem de utilizar esta Classe √© que ela j√° est√° configurada para executar testes a partir do **M√≥dulo App**, ou seja, voc√™ pode escrever testes para qualquer M√≥dulo da aplica√ß√£o sem a necessidade de grandes configura√ß√µes.

1. Localize a Classe de Testes **app.e2e-spec.ts**, na pasta **test**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/yxWtRqG.png" title="source: imgur.com" /></div>

2. Renomeie a Classe **app.e2e-spec.ts** para **usuario.e2e-spec.ts**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/5Oq2zw1.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao escrever os testes da aplica√ß√£o. Observe que a pasta test est√° localizada fora da pasta src.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

3. A Classe de Testes **usuario.e2e-spec.ts** originalmente estar√° implementada com o c√≥digo abaixo:

<div align="center"><img src="https://i.imgur.com/ySg8Iww.png" title="source: imgur.com" /></div>

Vamos fazer algumas altera√ß√µes na Classe:

**Linha 6:** Alterar **'AppController (e2e)'** por **'Testes dos M√≥dulos Usu√°rio e Auth (e2e)'**, para identificar os M√≥dulos que ser√£o testados.

**Linha 9:** Trocar **beforeEach** por **beforeAll**, porqu√™ n√£o precisamos que este M√©todo seja executado antes de cada M√©todo, uma √∫nica vez √© suficiente.

**Entre as linhas 14 e 15:** Vamos adicionar a linha de c√≥digo abaixo:

```typescript
app.useGlobalPipes(new ValidationPipe());
```

A linha acima, habilita as regras de valida√ß√£o dos atributos das Classes Entidade, atrav√©s das Bibliotecas **class-validator** e **class-transformer**, durante a exdcu√ß√£o dos testes.

**Linha 18 a 23:** Apagar o **M√©todo / (GET)** inteiro, porqu√™ ele est√° configurado para testar o HelloWorld e n√£o precisaremos mais deste M√©todo.

4. Ap√≥s as altera√ß√µes a nossa Classe de Testes ficar√° semelhante a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/xNCETvC.png" title="source: imgur.com" /></div>

Na sequ√™ncia, vamos configurar o Banco de dados de teste **db_blogpessoal_test.db**. Este Banco de dados ser√° criado para evitar que os testes modifiquem os dados do Banco de dados principal da aplica√ß√£o.

<br />

Na sequ√™ncia, vamos configurar o Banco de dados na Classe de Testes, atrav√©s do M√©todo **beforeAll()**.


1. Adicione a importa√ß√£o para a Biblioteca **Typeorm** na linha 5, como mostra a imagem abaixo:

   <div align="center"><img src="https://i.imgur.com/BoRqmkA.png" title="source: imgur.com" /></div>

2. Adicione as linhas do trecho de c√≥digo abaixo dentro do array **imports**, na linha 12, **M√©todo beforeAll()**:

```javascript
TypeOrmModule.forRoot({
    type: "sqlite",
    database: ":memory:",
    entities: [__dirname + "./../src/**/entities/*.entity.ts"],
    synchronize: true,
	dropSchema: true
}),
```

3. A altera√ß√£o acima est√° destacada na imagem abaixo na cor verde:

<div align="center"><img src="https://i.imgur.com/DIG23To.png" title="source: imgur.com" /></div>

Vamos detalhar o trecho de c√≥digo inserido:

**Linha 13:** Inserimos o M√≥dulo **TypeOrmModule** dentro do array **imports**. Neste M√≥dulo, atrav√©s do M√©todo **forRoot()** iremos configurar a conex√£o com o Banco de dados.

**Linha 14:** A propriedade **type** define o tipo do Banco de dados (SQLite)

**Linha 15:** A propriedade **database** define que o Banco de dados ser√° gerado na mem√≥ria, ou seja, ao finalizar o teste, o banco deixar√° de existir.

**Linha 16:** A propriedade **entities** informa onde est√£o as Classes Model da aplica√ß√£o, para o SQLIte gerar as tabelas no Banco de dados.

**Linha 17:** A propriedade **synchronize** definida como true indica que as tabelas do Banco de dados ser√£o criadas/atualizadas automaticamente em cada inicializa√ß√£o da aplica√ß√£o. Essa cria√ß√£o/atualiza√ß√£o est√° relacionada a estrutura das tabelas e n√£o aos dados.

**Linha 18:** A propriedade **dropSchema** definida como true apaga todas as tabelas do Banco de dados (DROP TABLE) e recria todas as tabelas. Esta propriedade √© √∫til num cen√°rio de testes para manter o ambiente controlado, entretanto n√£o deve ser utilizada em produ√ß√£o, porqu√™ acarretaria na perda de todos os dados do seu cliente toda vez que o sistema fosse reiniciado.

<br />


<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/modules" target="_blank"><b>Documenta√ß√£o: TypeOrmModule</b></a></div>

<div align="left"><img src="https://i.imgur.com/YcAjttZ.png" title="source: imgur.com" width="30px"/> <a href="https://typeorm.io/data-source-options#better-sqlite3-data-source-options" target="_blank"><b>Documenta√ß√£o: TypeOrmModule - Op√ß√µes de configura√ß√£o - SQLite 3</b></a></div>

<br />

Para finalizar, vamos criar o M√©todo **afterAll()**.


1. Acrescente o M√©todo **afterAll()**, trecho de c√≥digo abaixo, depois do M√©todo **beforeAll()**:

```typescript
afterAll(async () => {
	await app.close();
});
```

2. A altera√ß√£o acima est√° destacada na imagem abaixo na cor verde:

<div align="center"><img src="https://i.imgur.com/b5j1WAX.png" title="source: imgur.com" /></div>

Vamos entender as altera√ß√µes efetuadas:

O **M√©todo beforeAll()** ser√° executado uma √∫nica vez antes de iniciar os testes. Ele tem como principal responsabilidade criar o M√≥dulo de Testes da aplica√ß√£o (**Test.createTestingModule()**), definindo:

- O Banco de dados que ser√° utilizado durante os testes (**Banco de dados SQLite em mem√≥ria**), atrav√©s do M√©todo **TypeOrmModule.forRoot()**.

- Os M√≥dulos que ser√£o testados (**AppModule**).

Como a Classe de Testes **usuario.e2e-specs.ts** est√° configurada para testar o **M√≥dulo App** (M√≥dulo principal da aplica√ß√£o), podemos escrever testes para qualquer M√≥dulo dentro desta Classe de teste, entretanto por uma quest√£o de Boas Pr√°ticas, vamos criar testes apenas para os M√≥dulos Usu√°rio e Auth. 

> [!TIP]
>
> **Para escrevermos testes para os outros M√≥dulos do Projeto Blog Pessoal (Postagem e Tema), crie uma Classe de teste para cada m√≥dulo dentro da pasta test, nomeie cada Classe de teste com o nome do m√≥dulo seguindo os padr√µes utilizados na Classe de Testes do M√≥dulo usu√°rio (*postagem.e2e-spec.ts* e *tema.e2e-spec.ts*) e escreva os respectivos testes de cada M√≥dulo.**

Ap√≥s criarmos o ambiente de testes, o pr√≥ximo passo √© inicializar o ambiente de testes como uma aplica√ß√£o, atrav√©s do M√©todo **app.init()**, da mesma forma que inicializamos a aplica√ß√£o na **Classe Main**. Na pr√°tica, o Nest ir√° subir uma c√≥pia do Projeto Blog Pessoal, utilizando a configura√ß√£o do Banco de dados de teste (SQLite), para n√£o modificar os dados persistidos no banco de dados da aplica√ß√£o (MySQL).

O **M√©todo afterAll()**, tem a responsabilidade de finalizar a aplica√ß√£o quando todos os testes forem executados e finalizados, atrav√©s do M√©todo **app.close()**.

Abaixo voc√™ confere o c√≥digo da Classe de testes do M√≥dulo Usuario com todas as altera√ß√µes implementadas:

```javascript
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from './../src/app.module';
import { TypeOrmModule } from '@nestjs/typeorm';

describe('Testes dos M√≥dulos Usu√°rio e Auth (e2e)', () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [
        TypeOrmModule.forRoot({
          type: "sqlite",
          database: ":memory:",
          entities: [__dirname + "./../src/**/entities/*.entity.ts"],
          synchronize: true,
          dropSchema: true
        }),
        AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });
  
});
```

Agora estamos prontos para escrever os nossos M√©todos de teste!	

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
