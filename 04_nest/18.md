<h1>Projeto 02 - Blog Pessoal - M√≥dulo Usu√°rio - Parte 02</h1>

<br />

O que veremos por aqui:

1. Criar a Classe UsuarioService
2. Atualizar a Classe Postagem Service
3. Criar a Classe UsuarioController
4. Registrar as Classes UsuarioService e UsuarioController na Classe M√≥dulo UsuarioModule
5. Testar todos os M√©todos no Insomnia
6. Atualizar as Requisi√ß√µes Cadastrar e Atualizar Postagem no Insomnia

<br />

<h2>1. O M√≥dulo Usuario</h2>



Na etapa anterior, come√ßamos a construir o M√≥dulo Usuario e criamos o Relacionamento entre as Classes Usuario e Postagem. Veja o Diagrama de Classes abaixo: 

<div align="center"><img src="https://i.imgur.com/BOcR7EZ.jpg" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar o M√≥dulo Usuario. Todas as Classes constru√≠das no M√≥dulo Postagem dever√£o ser constru√≠das no M√≥dulo Usuario com as adapta√ß√µes pertinentes, especialmente nos M√©todos das Classes UsuarioService  e UsuarioController do M√≥dulo Usuario.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="150px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre como criar as Classes UsuarioService e UsuarioController, executar o projeto, entre outras, consulte a Documenta√ß√£o do M√≥dulo Postagem.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Em rela√ß√£o ao Banco de dados **db_blogpessoal**, o DER ficar√° igual a imagem abaixo: 

<div align="center"><img src="https://i.imgur.com/Xu5hn4q.jpg" title="source: imgur.com" /></div>

<br />


<h2>üë£ Passo 01 - Criar a Classe UsuarioService</h2>



Vamos criar a pasta **services**, dentro do nosso **M√≥dulo Usuario** (pasta usuario):

1. Na pasta **usuario**, clique com o bot√£o direito do mouse e clique na op√ß√£o **New Folder** (Nova Pasta). 

2. Digite o nome da pasta (**services**) e pressione a tecla **enter** do seu teclado para concluir. 
2. A estrutura de pasta do M√≥dulo Usuario, ficar√° igual a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/g4MfnL6.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar a pasta services. Um erro muito comum √© criar a pasta services fora da pasta usuario.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Na sequ√™ncia, vamos criar a Classe de Servi√ßo **UsuarioService** que chamaremos de **usuario.service.ts**:

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe de Servi√ßo. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest (nome_do_modulo.tipo_da_classe.ts) para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

1. Clique com o bot√£o direito do mouse sobre a **pasta services**, que foi criada dentro da pasta **usuario**, como mostra a figura abaixo, e na sequ√™ncia clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**usuario.service.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/8s9o3ir.png" title="source: imgur.com" /></div>

Veja abaixo a implementa√ß√£o da Classe **UsuarioService**:

```typescript
import { HttpException, HttpStatus, Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Usuario } from '../entities/usuario.entity';
import { Bcrypt } from '../../auth/bcrypt/bcrypt';

@Injectable()
export class UsuarioService {
    constructor(
        @InjectRepository(Usuario)
        private usuarioRepository: Repository<Usuario>,
        private bcrypt: Bcrypt
    ) { }

    async findByUsuario(usuario: string): Promise<Usuario | undefined> {
        return await this.usuarioRepository.findOne({
            where: {
                usuario: usuario
            }
        })
    }

    async findAll(): Promise<Usuario[]> {
        return await this.usuarioRepository.find();

    }

    async findById(id: number): Promise<Usuario> {

        const usuario = await this.usuarioRepository.findOne({
            where: {
                id
            }
        });

        if (!usuario)
            throw new HttpException('Usuario n√£o encontrado!', HttpStatus.NOT_FOUND);

        return usuario;

    }

    async create(usuario: Usuario): Promise<Usuario> {
        
        const buscaUsuario = await this.findByUsuario(usuario.usuario);

        if (buscaUsuario)
            throw new HttpException("O Usuario j√° existe!", HttpStatus.BAD_REQUEST);

        usuario.senha = await this.bcrypt.criptografarSenha(usuario.senha)
        return await this.usuarioRepository.save(usuario);

    }

    async update(usuario: Usuario): Promise<Usuario> {

        await this.findById(usuario.id);

        const buscaUsuario = await this.findByUsuario(usuario.usuario);

        if (buscaUsuario && buscaUsuario.id !== usuario.id)
            throw new HttpException('Usu√°rio (e-mail) j√° Cadastrado!', HttpStatus.BAD_REQUEST);

        usuario.senha = await this.bcrypt.criptografarSenha(usuario.senha)
        return await this.usuarioRepository.save(usuario);

    }

}
```

Vamos analisar a implementa√ß√£o do c√≥digo, com foco nas diferen√ßas de implementa√ß√£o em rela√ß√£o aos M√≥dulos anteriores:

<br />

<h3> 1.1 M√©todo Constructor()</h3>



O M√©todo **Constructor()** recebe as **Inje√ß√µes de Depend√™ncia** necess√°rias para o desenvolvimento da Classe de Servi√ßo.

<div align="center"><img src="https://i.imgur.com/QnZtdHW.png" title="source: imgur.com" /></div>

**Linhas 10 a 12:** Al√©m da inje√ß√£o de depend√™ncia de **usuarioRepository**, o m√©todo tamb√©m receber√° a inje√ß√£o de depend√™ncia da **Classe Bcrypt**, que foi criada como uma classe de servi√ßo no m√≥dulo **Auth**. Dessa forma, poderemos criptografar o atributo **senha** antes de persistir o objeto da classe **Usuario** no banco de dados.

<br />

<h3> 1.2 M√©todo findByUsuario(usuario: string)</h3>



O m√©todo **findByUsuario(usuario: string)** ser√° respons√°vel por **verificar se o atributo usuario (e-mail)** do objeto **Usuario** j√° existe antes de ser persistido, atualizado ou utilizado para autentica√ß√£o (login) na aplica√ß√£o. Esse m√©todo √© fundamental para o funcionamento do **Passport**, garantindo que apenas usu√°rios v√°lidos e registrados possam realizar opera√ß√µes de login ou altera√ß√µes nos dados.

<div align="center"><img src="https://i.imgur.com/wzuG4C2.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 15:** Criamos o m√©todo ass√≠ncrono (async) chamado **findByUsuario(usuario: string)**, que retorna uma **Promise** contendo um objeto da classe **Usuario** (caso o objeto seja encontrado) ou **undefined** (caso o objeto n√£o seja encontrado).

Observe que o m√©todo **findByUsuario(usuario: string)** possui um par√¢metro do tipo **string**, chamado **usuario**, que ser√° utilizado para procurar o e-mail do usu√°rio desejado.

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao implementar a  Classe Usuario Service. N√£o confunda o parametro usuario: string com o Objeto da Classe Usuario usuario: Usuario. Embora tenham o mesmo nome, eles n√£o s√£o a mesma coisa.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linha 16:** Executa o m√©todo **findOne()**, da classe **usuarioRepository**. O resultado da execu√ß√£o do m√©todo **findOne()** ser√° um objeto **Usuario** espec√≠fico, selecionado com base nos crit√©rios definidos pela cl√°usula **where**. Para ilustrar, em uma consulta SQL equivalente, o m√©todo seria similar √† instru√ß√£o: `SELECT * FROM tb_usuarios WHERE usuario = usuario_procurado;`.

**Linhas 17 e 18:** A cl√°usula **where** √© definida utilizando a vari√°vel **usuario** como crit√©rio de busca, ou seja, o m√©todo buscar√° o objeto **Usuario** cujo atributo **usuario** seja igual √† string **usuario** (e-mail) fornecida no par√¢metro do m√©todo **findByUsuario(usuario: string)**.

<br />

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="4%"/> <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-0.html" target="_blank"><b>Documenta√ß√£o: TypeScript undefined (tipo Indefinido)</b></a></div>

<div align="left"><img src="https://i.imgur.com/OtnA0bd.png" title="source: imgur.com" width="4%"/> <a href="https://typeorm.io/find-options" target="_blank"><b>Documenta√ß√£o: <i>TypeORM - M√©todo de busca find()</i></b></a></div>

<br />

<h3> 1.3 M√©todo create(usuario: Usuario)</h3>



O m√©todo **create(usuario: Usuario)** ser√° respons√°vel por **persistir um objeto da classe Usuario**. Esse m√©todo √© essencial para o funcionamento do **Passport**, pois sem o registro do usu√°rio (e-mail) e da senha, n√£o ser√° poss√≠vel acessar a aplica√ß√£o.

Al√©m disso, antes de persistir os dados do usu√°rio no banco de dados, o m√©todo realizar√° duas etapas importantes:

1. Verificar√° se o **usu√°rio (e-mail)** j√° existe, impedindo a duplica√ß√£o de registros.
2. Aplicar√° a **criptografia Bcrypt** na senha, garantindo que a senha do usu√°rio seja armazenada de forma segura.

<div align="center"><img src="https://i.imgur.com/2OAKsGJ.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 43:** Criamos o m√©todo ass√≠ncrono (async), chamado **create(usuario: Usuario)**, que retorna uma **Promise** contendo um objeto da classe **Usuario** que foi persistido no banco de dados da aplica√ß√£o.

Observe que o m√©todo **create(usuario: Usuario)** possui um par√¢metro do tipo **Usuario**, chamado **usuario**. Esta vari√°vel receber√° um objeto da classe **Usuario**, que ser√° enviado no corpo da requisi√ß√£o (Request Body), conforme as regras definidas na entidade **Usuario** (tamanho, possibilidade de ser nulo, possibilidade de estar vazio, entre outras). O objeto **usuario** ser√° enviado pelo m√©todo da **Classe UsuarioController** atrav√©s de um **JSON**, semelhante ao exemplo abaixo:

```json
{
    "nome": "Administrador",
    "usuario": "admin@email.com.br",
    "senha": "admin123",
    "foto": "https://i.imgur.com/JR7kUFU.jpg"
}
```

Observe que todos os atributos ser√£o enviados, **exceto o id**, pois ele **ser√° atribu√≠do automaticamente pelo banco de dados** ap√≥s o objeto ser persistido.

**Linha 45:** Criamos um objeto da classe **Usuario**, chamado **buscaUsuario**, para armazenar o resultado da execu√ß√£o do m√©todo **findByUsuario(usuario: string)** da classe **UsuarioService**. O objetivo √© verificar se o atributo **usuario** (e-mail) do objeto que ser√° persistido j√° existe.

**Linha 47:** Verifica se o objeto **buscaUsuario n√£o √© nulo**, ou seja, se o objeto da classe **Usuario** j√° existe. Caso o objeto n√£o exista, ele pode ser persistido no banco de dados.

**Linha 48:** Se o objeto **buscaUsuario** n√£o for nulo, ou seja, o usu√°rio foi encontrado, ser√° retornado o HTTP status **BAD REQUEST ü°™ 400** (O Usu√°rio j√° existe!).

**Linha 50:** Atrav√©s do **m√©todo criptografarSenha(senha: string)** da classe **Bcrypt** (no m√≥dulo **Auth**), vamos criptografar a senha do objeto **usuario** antes de persistir o objeto no banco de dados. Observe que a senha n√£o criptografada (digitada no login) ser√° substitu√≠da pela vers√£o criptografada.

**Linha 51:** Retorna a execu√ß√£o do m√©todo **save()** da interface **usuarioRepository**. O resultado da execu√ß√£o do m√©todo **save()** ser√° um objeto da classe **Usuario** persistido no banco de dados, na tabela **tb_usuarios**.

Em caso de sucesso na persist√™ncia, o retorno esperado do m√©todo **save()** ser√° a confirma√ß√£o do objeto persistido, no formato JSON, como mostrado no exemplo abaixo:

```json
{
    "id": 1,
    "nome": "Administrador",
    "usuario": "admin@email.com.br",
    "senha": "$2b$10$0VX70x6YbPwsXPZQq6TqL.inlrXIXDKC8qidomM8Vn8JLuglXzWEC",
    "foto": "https://i.imgur.com/JR7kUFU.jpg"
}
```

Observe que a senha est√° criptografada.

<br />

<h3> 1.4 M√©todo update(usuario: Usuario)</h3>



O **M√©todo `update(usuario: Usuario)`** ser√° respons√°vel por **atualizar os dados de um objeto da classe Usuario** que j√° foi persistido no banco de dados. Este m√©todo √© particularmente √∫til para alterar informa√ß√µes do usu√°rio, como a senha ou qualquer outro atributo, **exceto o id**, que √© gerado automaticamente pelo banco de dados e n√£o pode ser modificado.

<div align="center"><img src="https://i.imgur.com/K3VcdfA.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 55:** Criamos o m√©todo ass√≠ncrono (**async**), chamado **update(usuario: Usuario)**, que retornar√° uma **Promise** contendo o objeto da classe **Usuario** atualizado no banco de dados da aplica√ß√£o.

Observe que o m√©todo **update(usuario: Usuario)** recebe como par√¢metro um objeto do tipo **Usuario**, denominado **usuario**. Este objeto ser√° enviado no corpo da requisi√ß√£o (**Request Body**), seguindo as regras definidas na entidade **Usuario** (como tamanho, possibilidade de ser nulo ou vazio, entre outras). O objeto **usuario** ser√° enviado pelo m√©todo da **Classe UsuarioController** no formato **JSON**, conforme o exemplo abaixo:

```json
{
    "id": 1,
    "nome": "Administrador da Aplica√ß√£o",
    "usuario": "admin@email.com.br",
    "senha": "admin123",
    "foto": "https://i.imgur.com/JR7kUFU.jpg"
}
```

Note que todos os atributos do usu√°rio ser√£o enviados, **inclusive o id**, pois este ser√° utilizado para identificar qual objeto **Usuario** deve ser atualizado.

**Linha 57:** Chamamos o m√©todo **findById(id: number)**, da classe **UsuarioService**, para verificar se o objeto **Usuario** a ser atualizado j√° existe no banco de dados, com base no **id**.

**Linha 59:** Criamos um objeto da classe **Usuario**, chamado **buscaUsuario**, que ir√° armazenar o resultado da execu√ß√£o do m√©todo **findByUsuario(usuario: string)**, da classe **UsuarioService**. O objetivo √© verificar se o atributo **usuario** (o e-mail) do objeto a ser atualizado j√° existe no banco de dados.

**Linha 61:** Verificamos se o objeto **buscaUsuario n√£o √© nulo** e se o **atributo id** do objeto **buscaUsuario** (encontrado no banco de dados) √© diferente do **atributo id** do objeto **usuario** (enviado na requisi√ß√£o).

A primeira condi√ß√£o no **if** verifica se o e-mail fornecido no par√¢metro **usuario** j√° existe no banco de dados. Caso exista, o objeto **buscaUsuario** n√£o ser√° nulo.

Observe que **n√£o √© suficiente apenas verificar se o e-mail existe**. Tamb√©m precisamos **garantir que o e-mail pertence ao usu√°rio correto**. Se o id do usu√°rio no banco de dados for diferente do id enviado na requisi√ß√£o, significar√° que o e-mail est√° sendo usado por outro usu√°rio, o que resultar√° em uma **duplica√ß√£o de e-mails**.

A segunda condi√ß√£o do **if** verifica se o **id enviado na requisi√ß√£o** √© diferente do **id encontrado no banco de dados**. Se for diferente, significa que o e-mail est√° associado a outro usu√°rio, e a atualiza√ß√£o n√£o poder√° ser realizada.

**Linha 62:** Se ambas as condi√ß√µes forem satisfeitas, ou seja, se o e-mail j√° estiver sendo usado por outro usu√°rio, ser√° retornado o status HTTP **BAD REQUEST ü°™ 400** com a mensagem: "**O e-mail que voc√™ est√° tentando atualizar j√° pertence a outro usu√°rio!**".

**Linha 64:** Caso contr√°rio, utilizamos o **m√©todo criptografarSenha(senha: string)** da classe **Bcrypt**, do m√≥dulo **Auth**, para criptografar a senha do objeto **usuario** antes de persistir a atualiza√ß√£o no banco de dados. A senha **n√£o criptografada** (informada durante o login) ser√° substitu√≠da pela vers√£o **criptografada**.

**Linha 65:** Retornamos a execu√ß√£o do m√©todo **save()**, da interface **usuarioRepository**. O resultado dessa execu√ß√£o ser√° o objeto **Usuario** atualizado no banco de dados, na tabela **tb_usuarios**.

Se a atualiza√ß√£o for bem-sucedida, o retorno esperado do m√©todo **save()** ser√° a confirma√ß√£o do objeto persistido com as altera√ß√µes, no formato **JSON**, conforme o exemplo abaixo:

```json
{
    "id": 1,
    "nome": "Administrador da Aplica√ß√£o",
    "usuario": "admin@email.com.br",
    "senha": "$2b$10$mXsoRRRUT1moBDzTZfhyKuKApUHFugyRDqAdQEPumnrwGrmXuzeNy",
    "foto": "https://i.imgur.com/JR7kUFU.jpg"
}
```

Observe que a senha est√° criptografada, entretanto a hash da criptografia est√° diferente, porqu√™ mesmo a senha sendo a mesma, cada vez que o **M√©todo criptografarSenha(senha: string)** √© executado, uma hash diferente √© gerada.

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="4%"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/12_Recurso_Usuario/blogpessoal/src/usuario/services/usuario.service.ts" target="_blank"><b>C√≥digo fonte da Classe UsuarioService</b></a></div>

<br />

<h2>üë£ Passo 02 - Atualizar a Classe PostagemService</h2>



Da mesma forma que adicionamos o comando **relations na Classe UsuarioService**, tamb√©m iremos **atualizar o comando relations na Classe PostagemService**, nos M√©todos **findAll(), findById(id: number) e findByTitulo(titulo: string)**, adicionando o Objeto da Classe usuario, como mostra imagem abaixo:

<div align="center"><img src="https://i.imgur.com/WnaJZyf.png" title="source: imgur.com" /></div>

Observe que acrescentamos o atributo usuario logo abaixo do Objeto tema, separados por uma virgula.

Desta forma, ao executar os M√©todos  **findAll(), findById(id: number) e findByTitulo(titulo: string)**, os Objetos da Classe Postagem passar√£o a exibir os Objetos das Classes Tema e Usuario associados, semelhante ao exemplo abaixo:

```json
{
    "id": 4,
    "titulo": "Minha Postagem 04",
        "texto": "Texto da Postagem 04",
        "data": "2022-07-14T11:51:00.954Z",
    "tema": {
        "id": 1,
        "descricao": "Usuario 01"
    },
        "usuario": {
        "id": 1,
        "nome": "Administrador",
        "usuario": "admin@email.com.br",
        "senha": "$2b$10$0VX70x6YbPwsXPZQq6TqL.inlrXIXDKC8qidomM8Vn8JLuglXzWEC",
        "foto": "https://i.imgur.com/JR7kUFU.jpg"
    }
}
```

Veja abaixo a implementa√ß√£o atualizada da Classe **PostagemService**:

```typescript
import { HttpException, HttpStatus, Injectable } from "@nestjs/common";
import { InjectRepository } from "@nestjs/typeorm";
import { DeleteResult, ILike, Repository } from "typeorm";
import { TemaService } from "../../tema/services/tema.service";
import { Postagem } from "../entities/postagem.entity";

@Injectable()
export class PostagemService {
    constructor(
        @InjectRepository(Postagem)
        private postagemRepository: Repository<Postagem>,
        private temaService:TemaService
    ) { }

    async findAll(): Promise<Postagem[]> {
        return await this.postagemRepository.find({
            relations:{
                tema: true,
                usuario: true
            }
        });
    }

    async findById(id: number): Promise<Postagem> {

        const postagem = await this.postagemRepository.findOne({
            where: {
                id
            },
            relations:{
                tema: true,
                usuario: true
            }
        });

        if (!postagem)
            throw new HttpException('Postagem n√£o encontrada!', HttpStatus.NOT_FOUND);

        return postagem;
    }

    async findByTitulo(titulo: string): Promise<Postagem[]> {
        return await this.postagemRepository.find({
            where:{
                titulo: ILike(`%${titulo}%`)
            },
            relations:{
                tema: true,
                usuario: true
            }
        })
    }

    async create(postagem: Postagem): Promise<Postagem> {
       
      	await this.temaService.findById(postagem.tema.id)
            
        return await this.postagemRepository.save(postagem);

    }

    async update(postagem: Postagem): Promise<Postagem> {
        
		await this.findById(postagem.id);

		await this.temaService.findById(postagem.tema.id)
                
		return await this.postagemRepository.save(postagem);
    
    }

    async delete(id: number): Promise<DeleteResult> {
        
        await this.findById(id);

        return await this.postagemRepository.delete(id);

    }

}
```

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="4%"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/12_Recurso_Usuario/blogpessoal/src/postagem/services/postagem.service.ts" target="_blank"><b>C√≥digo fonte da Classe PostagemService</b></a></div>

<br />

<h2>üë£ Passo 03 - Criar a Classe UsuarioController</h2>



Vamos criar a pasta **controllers**, dentro do nosso **M√≥dulo Usuario** (pasta usuario):

1. Na pasta **usuario**, clique com o bot√£o direito do mouse e clique na op√ß√£o **New Folder** (Nova Pasta). 

2. Digite o nome da pasta (**controllers**) e pressione a tecla **enter** do seu teclado para concluir. 
2. A estrutura de pasta do M√≥dulo Usuario, ficar√° igual a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/PeQQ3Vq.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar a pasta controllers. Um erro muito comum √© criar a pasta controllers fora da pasta usuario.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Na sequ√™ncia, vamos criar a Classe Controladora **UsuarioController** que chamaremos de **usuario.controller.ts**:

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="320px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe de Servi√ßo. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest (nome_do_modulo.tipo_da_classe.ts) para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta controllers**, que foi criada dentro da pasta **usuario**, como mostra a figura abaixo, e clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**usuario.controller.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/DPeGvxz.png" title="source: imgur.com" /></div>

Veja abaixo a implementa√ß√£o da Classe **UsuarioController**:

```typescript
import { Body, Controller, Get, HttpCode, HttpStatus, Param, ParseIntPipe, Post, Put } from "@nestjs/common";
import { UsuarioService } from "../services/usuario.service";
import { Usuario } from "../entities/usuario.entity";


@Controller("/usuarios")
export class UsuarioController{

    constructor(private readonly usuarioService: UsuarioService){ }

    @Get('/all')
    @HttpCode(HttpStatus.OK)
    findAll(): Promise<Usuario[]>{
        return this.usuarioService.findAll();
    }

    @Get('/:id')
    @HttpCode(HttpStatus.OK)
    findById(@Param('id', ParseIntPipe) id: number): Promise<Usuario>{
        return this.usuarioService.findById(id)
    }

    @Post('/cadastrar')
    @HttpCode(HttpStatus.CREATED)
    async create(@Body() usuario: Usuario): Promise<Usuario>{
        return this.usuarioService.create(usuario)
    }

    @Put('/atualizar')
    @HttpCode(HttpStatus.OK)
    async update(@Body() usuario: Usuario): Promise<Usuario>{
        return this.usuarioService.update(usuario)
    }

}
```
Observe que a implementa√ß√£o √© semelhante as Classes **PostagemController** e **TemaController**, entretanto **implementamos apenas os M√©todos findAll(), fidnById(), create() e update()**. Os demais M√©todos do M√≥dulo Usu√°rio n√£o precisam ser expostos na Classe Controladora.

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="4%"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/12_Recurso_Usuario/blogpessoal/src/usuario/controllers/usuario.controller.ts" target="_blank"><b>C√≥digo fonte da Classe UsuarioController</b></a></div>

<br />

<h2>üë£ Passo 04 - Registrar as Classes UsuarioService e UsuarioController na Classe UsuarioModule</h2>



Na sequ√™ncia, vamos registrar as nossas Classes **UsuarioService** e **UsuarioController**, no M√≥dulo **UsuarioModule**. Esse passo √© fundamental para o correto funcionamento da nossa aplica√ß√£o.

1. Abra a Classe **UsuarioModule**, localizada na pasta **usuario**, conforme indicada na imagem abaixo:

   <div align="center"><img src="https://i.imgur.com/5eD78El.png" title="source: imgur.com" /></div>

2. Implemente as altera√ß√µes, indicadas pelas setas na imagem abaixo:

 <div align="left"><img src="https://i.imgur.com/vES6UNR.png" title="source: imgur.com" /></div>

Vamos analisar as altera√ß√µes no c√≥digo:

**Linhas 9 a 12:** No array **imports**, vamos adicionar a **Classe AuthModule** do **M√≥dulo Auth**. Dessa forma, a classe de servi√ßo **Bcrypt** poder√° ser injetada em outras classes dentro do **M√≥dulo Usuario**. Observe que utilizamos na importa√ß√£o da Classe AuthModule o m√©todo **forwardRef()**, para evitar o erro de refer√™ncia circular, porque AuthModule utilizar√° UsuarioModule e vice-versa.

**Linha 13:** No array **providers**, vamos adicionar a **Classe UsuarioService** do **M√≥dulo Usuario**. Com isso, a classe de servi√ßo **UsuarioService** poder√° ser injetada em outras classes dentro do **M√≥dulo Usuario**.

**Linha 14:** No array **controllers**, vamos adicionar a **Classe UsuarioController** do **M√≥dulo Usuario**. Isso permitir√° que os endpoints da classe controladora estejam dispon√≠veis para receber requisi√ß√µes HTTP.

**Linha 15:** No array **exports**, vamos adicionar a **Classe UsuarioService** do **M√≥dulo Usuario**. Com isso, os m√©todos da classe de servi√ßo **UsuarioService** estar√£o dispon√≠veis para serem utilizados em outros m√≥dulos da aplica√ß√£o.

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao Registrar novas Classes no M√≥dulo. Observe que ap√≥s registrar uma nova Classe, novas importa√ß√µes de Classes ser√£o necess√°rias nas primeiras linhas da Classe UsuarioModule.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="4%"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/12_Recurso_Usuario/blogpessoal/src/usuario/usuario.module.ts" target="_blank"><b>C√≥digo fonte da Classe UsuarioModule</b></a></div>

<br />

<h2>üë£ Passo 05 - Executar o projeto</h2>



1. Verifique se voc√™ est√° dentro da pasta do projeto, como mostra a figura abaixo:


<div align="center"><img src="https://i.imgur.com/67GK3fX.png" title="source: imgur.com" /></div>

2. Digite o comando ***npm run start:dev***, para compilar e executar o nosso projeto **blogpessoal**, caso n√£o esteja em execu√ß√£o. 

```bash
npm run start:dev
```

3. Se tudo deu certo, o resultado ser√° semelhante ao da figura abaixo:

<div align="center"><img src="https://i.imgur.com/xymrXM9.png" title="source: imgur.com" /></div>

4.Observe que os 3 endpoints do **M√≥dulo Usuario** foram disponibilizados no endere√ßo **/usuarios** 

<br />

<h2>üë£ Passo 06 - Testar o M√≥dulo Usuario no Insomnia</h2>



Vamos criar no Insomnia todas as requisi√ß√µes necess√°rias para testar os 3 M√©todos do M√≥dulo Usuario. Veja abaixo como ficam as requisi√ß√µes para testar o M√≥dulo Usuario:

<br />


| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre como criar as Requisi√ß√µes, consulte a Documenta√ß√£o dos M√≥dulos Postagem e Tema.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="120px"/> | <div align="left"> **ATEN√á√ÉO:** *Depois de criar o Relacionamento entre Classes, todas as Consultas dos M√≥dulos Postagem, Tema e Usuario trar√£o os Objetos associados.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h3>6.1. Criando a Pasta Usuario</h3>



Vamos criar dentro da **Collection Blog Pessoal** a **Pasta Usuario**, que guardar√° todas as requisi√ß√µes do **Recurso Usuario**.

1. Na **Collection Blog Pessoal**, clique no bot√£o <img src="https://i.imgur.com/3Ou2SAZ.png" title="source: imgur.com" width="6%"/>. No menu que ser√° aberto, clique na op√ß√£o **New Folder**.

<div align="center"><img src="https://i.imgur.com/44vqfU9.png" title="source: imgur.com" width="50%"/></div>

2. Na janela que ser√° aberta, informe o nome da pasta (**Usuario**) e clique no bot√£o **Create** para concluir. 

<div align="center"><img src="https://i.imgur.com/etf4wwv.png" title="source: imgur.com" width="90%"/></div>

<br />

<h3>6.2. Criando a  Requisi√ß√£o - Cadastrar Usuario</h3>



Vamos come√ßar pela requisi√ß√£o Cadastrar Usuario porqu√™ sem um usu√°rio cadastrado n√£o ser√° poss√≠vel autenticar (logar) no sisusuario e acessar os demais endpoints.

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/BIsfvDG.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**POST**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/d2gv8YO.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo Post o Corpo da requisi√ß√£o (Request Body) deve ser preenchido com um JSON contendo o nome, o usuario(e-mail), a senha e a foto(link), que vc deseja persistir no Banco de dados.

9. Observe que depois de persistir os dados do usuario, a aplica√ß√£o retornar√° a senha criptografada.

<div align="center"><img src="https://i.imgur.com/75wANgh.png" title="source: imgur.com" /></div>

<br />

<h3>6.3. Criando a  Requisi√ß√£o - Consultar todos os Usuarios</h3>




1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/Veedyux.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**GET**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/djGk2ZU.png" title="source: imgur.com" /></div>

6. O resultado da requisi√ß√£o voc√™ confere na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/9l6RX5s.png" title="source: imgur.com" /></div>

7. Observe que ser√° exibido no final do Objeto Usuario o **array postagem**. Caso o usu√°rio crie novas postagens, elas ser√£o exibidas dentro deste array.

<br />

<h3>6.4. Criando a  Requisi√ß√£o - Consultar Usu√°rio por ID</h3>



1. Clique com o bot√£o direito do mouse sobre a **Pasta Usu√°rio** para abrir o menu e clique na op√ß√£o **New Request**.

<div align="center"><img src="https://i.imgur.com/apLv4rG.png" title="source: imgur.com" /></div>

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usu√°rio**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/RLUrAOZ.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**GET**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/YDd8OZo.png" title="source: imgur.com" /></div>

<br />

<h3>6.5. Criando a  Requisi√ß√£o - Atualizar Usu√°rio</h3>



1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Requisi√ß√£o**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/dE5zZge.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**PUT**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/z6dWHYj.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure o endere√ßo da requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/CDzrTjG.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo **PUT** o Corpo da requisi√ß√£o (Request Body) deve ser preenchido com um JSON contendo o Id, o nome, o usuario (e-mail), a senha e a foto(link) que vc deseja atualizar no Banco de dados.

9. O resultado da Requisi√ß√£o voc√™ confere na imagem abaixo:


<div align="center"><img src="https://i.imgur.com/EBmK0F7.png" title="source: imgur.com" width="90%"/></div>

<br />

<h2>üë£ Passo 07 - Atualizar as Requisi√ß√µes Cadastrar e Atualizar Postagem no Insomnia</h2>



Como habilitamos o Relacionamento entre as Classes Postagem e Usuario, para Cadastrarmos e Alterarmos as Postagens vamos precisar atender alguns requisitos:

- O Tema e o Usuario devem ser persistidos antes de criar a nova Postagem.
- Na requisi√ß√£o Cadastrar e Atualizar Postagem, o JSON enviado no Corpo da Requisi√ß√£o deve conter um Objeto da Classe Tema identificado apenas pelo **Atributo id** e um Objeto da Classe Usuario identificado apenas pelo **Atributo id**.

<br />

| <img src="https://i.imgur.com/nSpXEZ0.png" title="source: imgur.com" width="100px"/> | **IMPORTANTE:** *O Objeto da Classe Usuario n√£o ser√° validado na Classe PostagemService, da mesma forma que fizemos com o Tema, porqu√™ ao fazer o Login os dados do Objeto Usuario ficar√£o dispon√≠veis no LocalStorage (assunto para o front-end) do Navegador, validados pelo login.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<h3>7.1. Atualiza√ß√£o - Requisi√ß√£o Cadastrar Postagem</h3>



Vamos alterar o Corpo da requisi√ß√£o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/ygSi87a.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, al√©m do Objeto da Classe Tema, que foi inserido anteriormente.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATEN√á√ÉO:** *O Objeto Usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisi√ß√£o Cadastrar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<h3>7.2. Atualiza√ß√£o - Requisi√ß√£o Atualizar Postagem</h3>



Vamos alterar o Corpo da requisi√ß√£o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/iWqujdB.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, al√©m do Objeto da Classe Tema, que foi inserido anteriormente.

N√£o esque√ßa de inserir o token no cabe√ßalho da requisi√ß√£o.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATEN√á√ÉO:** *O Objeto Usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisi√ß√£o Atualizar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="35px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/tree/12_Recurso_Usuario" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
