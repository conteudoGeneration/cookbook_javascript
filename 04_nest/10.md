<h1>Projeto 02 - Blog Pessoal - Classe PostagemController e PostagemService - M√©todo Cadastrar Postagem</h1>



O que veremos por aqui:

1. Criar o m√©todo create(postagem: Postagem) na Classe PostagemService
2. Criar o m√©todo create(postagem: Postagem) na Classe PostagemController
3. Testar os M√©todos no Insomnia

<br />

<h2>1. O M√≥dulo Postagem</h2>



Nas etapas anteriores, come√ßamos a construir as Classes **PostagemService** e **PostagemController** e implementamos os seguintes M√©todos:

-  **findAll()**  ü°™ Retorna todos os Objetos da Classe Postagem persistidos no Banco de dados.
-  **findById(id: number)** ü°™ Retorna um Objeto espec√≠fico da Classe Postagem persistido no Banco de dados. A Postagem √© identificada pelo atributo id. 
-  **findByTitulo(titulo: string)** ü°™ Retorna  todos os Objetos da Classe Postagem persistidos no Banco de dados, cujo atributo titulo contenha (em qualquer parte) a String enviada no par√¢metro titulo do M√©todo.   

Vamos continuar a constru√ß√£o das Classes **PostagemService** e  **PostagemController** implementando o M√©todo **create(postagem: Postagem)**, que persistir√° um novo Objeto da Classe Postagem no Banco de dados.

<div align="center"><img src="https://i.imgur.com/vmCMVTX.png" title="source: imgur.com" width="75%"/></div>

<br />

<h2>üë£ Passo 01 - Criar o M√©todo create na Classe PostagemService</h2>



Vamos implementar o M√©todo **create(postagem: Postagem)** na Classe PostagemService. Tra√ßando um paralelo com o SQL, seria o equivalente a instru√ß√£o: 

```sql
INSERT INTO tb_postagens (titulo, texto, data) VALUES ("T√≠tulo", "Texto", CURRENT_TIMESTAMP());
```

1. Abra a Classe **Postagem Service**, localizada na pasta **src/postagem/services**.

<div align="center"><img src="https://i.imgur.com/K9AHCEo.png?1" title="source: imgur.com" /></div>

2. Insira o c√≥digo abaixo depois do M√©todo **findByTitulo(titulo: string)**.

<div align="left"><img src="https://i.imgur.com/LarxRND.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 39:** O m√©todo ass√≠ncrono **create(postagem: Postagem)** √© respons√°vel por receber um objeto da classe **Postagem** e persistir seus dados no banco de dados. Ele utiliza as regras definidas na entidade **Postagem** (como tamanho m√°ximo dos campos, obrigatoriedade, entre outras valida√ß√µes). Caso o objeto esteja de acordo com as regras, ele ser√° salvo no banco e retornado na resposta da opera√ß√£o.

Esse m√©todo retorna uma **Promise**, que ser√° resolvida com o objeto da classe **Postagem** persistido. Caso ocorra um erro na valida√ß√£o ou na persist√™ncia, a Promise ser√° rejeitada com a mensagem de erro apropriada.

O par√¢metro **postagem** do m√©todo √© preenchido com os dados enviados pelo cliente no corpo da requisi√ß√£o HTTP (Request Body) e ser√° encaminhado pela **PostagemController** para o m√©todo **create** do **PostagemService** para que a persist√™ncia seja executada.

Se a cria√ß√£o for bem-sucedida, o m√©todo retorna o objeto salvo, incluindo o atributo id, que foi gerado automaticamente pelo banco de dados.

```json
{
    "titulo" : "Postagem 01",
    "texto" : "Texto da Postagem 01"
}
```

Observe que apenas os Atributos **titulo e texto** ser√£o enviados, porqu√™ o **id ser√° atribu√≠do pelo Banco de dados** ap√≥s o Objeto ser persistido e a **data ser√° atribu√≠da pelo Nest** (timestamp).

> **Timestamp:** Representa um instante √∫nico, um ponto espec√≠fico na linha  do tempo, e seu valor corresponde a uma determinada quantidade de tempo decorrida a partir de um instante inicial. Dentro do nosso contexto, a aplica√ß√£o consultar√° o Sistema Operacional para obter a data e a hora e gravar√° em um Atributo do Objeto (data, por exemplo) o momento exato em que ele foi criado ou atualizado.

**Linha 40:** Retorna a execu√ß√£o do M√©todo **save()**, da Classe **postagemRepository**. O resultado da execu√ß√£o do M√©todo **save()**, ser√° um Objeto da Classe Postagem persistido (salvo) no Banco de dados, na tabela **tb_postagens**.  

Observe que na instru√ß√£o **return** foi inserido o comando **await** (aguarde), que na pr√°tica significa espere que a **Promise** seja resolvida (a execu√ß√£o do m√©todo seja conclu√≠da), antes de retornar uma resposta para a Classe que acionou o M√©todo.

No caso de uma persist√™ncia dos dados, o retorno esperado do M√©todo **save()** ser√° a confirma√ß√£o do Objeto persistido, no formato JSON, como mostra o exemplo abaixo:

```json
{
    "id" : 1
    "titulo" : "Postagem 01",
    "texto" : "Texto da Postagem 01"
    "data": "2022-07-12T18:12:46.161Z"
}
```

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/providers" target="_blank"><b>Documenta√ß√£o: <i>Provedores - Classe de Servi√ßo</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/fundamentals/custom-providers" target="_blank"><b>Documenta√ß√£o: <i>Provedores Customizados - Classe de Servi√ßo</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/OtnA0bd.png" title="source: imgur.com" width="25px"/> <a href="https://typeorm.io/find-options" target="_blank"><b>Documenta√ß√£o: <i>TypeORM - M√©todo de busca find()</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/r9lrbPG.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank"><b>Documenta√ß√£o: Promise</b></a></div>

<div align="left"><img src="https://i.imgur.com/r9lrbPG.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/JavaScript/Reference/Operators/async_function" target="_blank"><b>Documenta√ß√£o: Async</b></a></div>

<div align="left"><img src="https://i.imgur.com/r9lrbPG.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/JavaScript/Reference/Operators/await" target="_blank"><b>Documenta√ß√£o: Await</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/07_Cadastrar_Atualizar_Postagem/blogpessoal/src/postagem/services/postagem.service.ts" target="_blank"><b>C√≥digo fonte da Classe PostagemService</b></a></div>

<br />

<h2>üë£ Passo 02 - Criar o M√©todo create na Classe PostagemController</h2>



Vamos implementar o M√©todo **create(@Body() postagem: Postagem)** na Classe PostagemController, que tem como objetivo executar o M√©todo com o mesmo nome na Classe de Servi√ßo PostagemService. 

1. Abra a Classe **PostagemController**, localizada na pasta **src/postagem/controllers**.

<div align="center"><img src="https://i.imgur.com/HaoDWSZ.png?1" title="source: imgur.com" /></div>

2. Insira o c√≥digo depois do M√©todo **findByTitulo(titulo: string)**.

<div align="left"><img src="https://i.imgur.com/RR5TZYT.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 27:** O decorador **@Post()** define que o M√©todo **create(@Body() postagem: Postagem)** ser√° respons√°vel por processar todas as requisi√ß√µes do tipo **HTTP POST** enviadas para o **endpoint** **http://localhost:4000/postagens/**.

Em outras palavras, qualquer requisi√ß√£o **POST** enviada para esse endere√ßo ser√° tratada pelo M√©todo **create** da classe controladora. Esse m√©todo √© utilizado para **criar novos registros** no banco de dados, recebendo os dados no **corpo da requisi√ß√£o (Request Body)** e processando-os de acordo com as regras definidas na aplica√ß√£o.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** *O Endere√ßo do endpoint do M√©todo create ser√° igual ao endere√ßo do M√©todo findAll. Como os verbos HTTP dos dois M√©todos s√£o diferentes, o mesmo endere√ßo pode ser de utilizado.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linha 28:** O decorador **@HttpCode(HttpStatus.CREATED)** indica que o M√©todo **create(@Body() postagem: Postagem)**, ter√° como **Resposta HTTP** padr√£o o status **CREATED ü°™ 201**, ou seja, quando a Resposta da Requisi√ß√£o for positiva (o Objeto for persistido no Banco de dados), ser√° retornado o **HTTP Status CREATED ü°™ 201**. Caso a Resposta seja negativa (algo deu errado), a Resposta depender√° do erro.

- **HTTP Status BAD REQUEST ü°™ 400**, caso seja um erro de valida√ß√£o de algum atributo do objeto
- **HTTP Status INTERNAL SERVER ERROR ü°™ 500**, caso ocorra algum erro no c√≥digo ou no servidor

**Linha 29:** Criamos o M√©todo **create(@Body() postagem: Postagem)**, que promete retornar uma **Promise**, que ser√° enviada pela Classe PostagemService, contendo um Objeto da Classe Postagem. 

**@Body():**  Este decorador **acessa o Objeto postagem enviado no corpo da Requisi√ß√£o e insere no Objeto postagem** (par√¢metro) do M√©todo **create(@Body() postagem: Postagem)**;

**Linha 30:** Executa o m√©todo **create(postagem: Postagem)**, **M√©todo da Classe PostagemService**, que retornar√° o Objeto da Classe Postagem persistido no Banco de dados. 

3. Ap√≥s a implementa√ß√£o do M√©todo **create(@Body() postagem: Postagem)**, observe que a linha 1 do c√≥digo ser√° atualizada com 2 novas importa√ß√µes, como mostra a figura abaixo (indicado em amarelo):

<div align="left"><img src="https://i.imgur.com/BGbky4w.png" title="source: imgur.com" /></div>

<br />

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href=" https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Methods" target="_blank"><b>Documenta√ß√£o: HTTP Methods Request</b></a></div>

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href=" https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Status" target="_blank"><b>Documenta√ß√£o: HTTP Status Code</b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/controllers" target="_blank"><b>Documenta√ß√£o: <i>Classe Controladora</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/providers" target="_blank"><b>Documenta√ß√£o: <i>Provedores - Classe Controladora</i></b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="35px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/07_Cadastrar_Atualizar_Postagem/blogpessoal/src/postagem/controllers/postagem.controller.ts" target="_blank"><b>C√≥digo fonte da Classe PostagemController</b></a></div>

<br />


<h2>üë£ Passo 03 - Executar o projeto</h2>



1. Verifique se voc√™ est√° dentro da pasta do projeto, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/JgNkmDv.png" title="source: imgur.com" /></div>

2. Digite o comando ***npm run start:dev***, para compilar e executar o nosso projeto **blogpessoal**, caso n√£o esteja em execu√ß√£o. 

```bash
npm run start:dev
```

3. Se tudo deu certo, observe na imagem abaixo, na regi√£o indicada em amarelo, que o endpoint do tipo **POST**, apontando para o caminho (rota) **/postagens**, foi disponibilizado.

<div align="center"><img src="https://i.imgur.com/avX3X6b.png" title="source: imgur.com" /></div>

<br />


<h2>üë£ Passo 04 - Testar o M√©todo create no Insomnia</h2>



Agora vamos criar a Requisi√ß√£o para o **M√©todo create(postagem: Postagem)**:

1. Clique com o bot√£o direito do mouse sobre a **Pasta Postagem** para abrir o menu e clique na op√ß√£o **New HTTP Request**.

<div align="center"><img src="https://i.imgur.com/KvRI8b2.png" title="source: imgur.com" /></div>

2.  Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Postagem**.

<div align="center"><img src="https://i.imgur.com/CA70WQn.png" title="source: imgur.com" /></div>

3. D√™ um duplo clique sobre a nova Requisi√ß√£o (**New Request**), informe o nome da Requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/z1mf3na.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**POST**) na Requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Postagem no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a Requisi√ß√£o conforme a imagem abaixo: 

<div align="center"><img src="https://i.imgur.com/L9D1Gvq.png" title="source: imgur.com" /></div>

8. No item marcado em amarelo na imagem acima, informe o endere√ßo (endpoint) da Requisi√ß√£o. A requisi√ß√£o **Cadastrar Postagem** foi configurada da seguinte maneira:

- A primeira parte do endere√ßo (http://localhost:4000) √© o endere√ßo do nosso servidor local. Quando a aplica√ß√£o estiver na nuvem, ele ser√° substitu√≠do pelo endere√ßo da nuvem.
- A segunda parte do endere√ßo √© o **endpoint** configurado no decorador ***@Controller***, em nosso caso **/postagens**.  

9. Na guia **JSON**, precisamos inserir um **JSON** com os dados que ser√£o inseridos na nova postagem. Lembrando que no padr√£o JSON: **o texto antes dos 2 pontos** (:) √© o **atributo** da Classe e **o texto depois dos 2 pontos** (:) √© o **dado** que ser√° cadastrado no atributo.  Os atributos s√£o separados por virgula, como mostra a imagem acima.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** Observe que no m√©todo **POST n√£o √© necess√°rio enviar os atributos id** (ser√° gerado pelo Banco de dados) e **data** (ser√° enviada pelo Nest) no JSON.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

10. Para testar a requisi√ß√£o, com a aplica√ß√£o rodando, clique no bot√£o <img src="https://i.imgur.com/sy0V8Nx.png" title="source: imgur.com" width="50px"/>.

11. O resultado da requisi√ß√£o voc√™ confere na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/NRsnpOR.png" title="source: imgur.com" /></div>

12. Observe que a aplica√ß√£o retorna al√©m dos dados que foram persistidos no Banco de dados com o id e a data, ela tamb√©m retorna um **HTTP Status 201 ü°™ CREATED** (indicado em verde na imagem acima). Este Status indica que a Requisi√ß√£o foi bem sucedida!

13. Caso os Atributos **titulo** ou **texto** sejam nulos ou em branco (indicado em amarelo), a aplica√ß√£o retornar√° o **HTTP Status 400 ü°™ BAD_REQUEST** (indicado em verde), devido a valida√ß√£o que foi inserida na Classe Postagem (**@IsNotEmpty**), como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/hPVAV1u.png" title="source: imgur.com" /></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/tree/07_Cadastrar_Atualizar_Postagem" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
