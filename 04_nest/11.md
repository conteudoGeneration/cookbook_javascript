<h1>Projeto 02 - Blog Pessoal - Classe PostagemController e PostagemService - M√©todo Atualizar Postagem</h1>



O que veremos por aqui:

1. Criar o m√©todo update(postagem: Postagem) na Classe PostagemService
2. Criar o m√©todo update(postagem: Postagem) na Classe PostagemController
3. Testar os M√©todos no Insomnia

<br />

<h2>1. O M√≥dulo Postagem</h2>



Nas etapas anteriores, come√ßamos a construir as Classes **PostagemService** e **PostagemController** e implementamos os seguintes M√©todos:

-  **findAll()**  ü°™ Retorna todos os Objetos da Classe Postagem persistidos no Banco de dados.
-  **findById(id: number)** ü°™ Retorna um Objeto espec√≠fico da Classe Postagem persistido no Banco de dados. A Postagem √© identificada pelo atributo id. 
-  **findByTitulo(titulo: string)** ü°™ Retorna  todos os Objetos da Classe Postagem persistidos no Banco de dados, cujo atributo titulo contenha (em qualquer parte) a String enviada no par√¢metro titulo do M√©todo.   
-  **M√©todo create(postagem: Postagem)** ü°™ Persiste (salva) um novo Objeto da Classe Postagem no Banco de dados.

Vamos continuar a constru√ß√£o das Classes **PostagemService** e  **PostagemController** implementando o M√©todo  **update(postagem: Postagem)**, que atualizar√° um Objeto da Classe Postagem persistido no Banco de dados.

<div align="center"><img src="https://i.imgur.com/EIm56Zk.png" title="source: imgur.com" width="75%"/></div>

<br />

<h2>üë£ Passo 01 - Criar o M√©todo update na Classe PostagemService</h2>



Vamos implementar o M√©todo **update(postagem: Postagem)** na Classe PostagemService. Tra√ßando um paralelo com o SQL, seria o equivalente a instru√ß√£o: <code>UPDATE tb_postagens SET titulo = "titulo", texto = "texto", data = CURRENT_TIMESTAMP() WHERE id = id;</code>.

1. Abra a Classe **Postagem Service**, localizada na pasta **src/postagem/services**.

<div align="center"><img src="https://i.imgur.com/K9AHCEo.png?1" title="source: imgur.com" /></div>

2. Insira o c√≥digo depois do M√©todo **create(@Body() postagem: Postagem)**.

<div align="left"><img src="https://i.imgur.com/ge3IjsS.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 43:** Criamos o M√©todo Ass√≠ncrono (async), chamado **update(postagem: Postagem)**, que promete retornar uma **Promise** contendo um Objeto da Classe Postagem, que foi atualizado no Banco de dados da aplica√ß√£o. 

Observe que o M√©todo **update(postagem: Postagem)** possui um par√¢metro do tipo **Postagem**, chamado **postagem**. Esta vari√°vel receber√° um Objeto da Classe Postagem, que ser√° enviado no Corpo da Requisi√ß√£o (Request Body), conforme as regras definidas na Entidade Postagem (Tamanho, Pode ser Nulo, Pode ser vazio, entre outras). O Objeto postagem ser√° enviado pelo M√©todo da **Classe PostagemController**, atrav√©s de um **JSON**, semelhante ao exemplo abaixo: 

```json
{
    "id" : 3,
    "titulo" : "Postagem 03 atualizada",
    "texto" : "Texto da Postagem 03 atualizado"
}
```

Observe que dieferente do M√©todo **create(postagem: Postagem)**, al√©m dos Atributos **titulo e texto**, **o id tamb√©m deve ser enviado para identificar a postagem que ser√° atualizada**. O Atributo **data** n√£o precisa ser enviado.

**Linha 45:** Criamos um Objeto da Classe Postagem, chamado **buscaPostagem**, para receber o resultado da execu√ß√£o do M√©todo **findById(id: number)**, da Classe **PostagemService**. O objetivo √© checar se a Postagem que ser√° atualizada existe, atrav√©s da busca pelo id.  Observe que na chamada do M√©todo **findById(id: number)** foi inserido o comando **await** (aguarde), que na pr√°tica significa espere que a **Promise** seja resolvida (a execu√ß√£o do m√©todo seja conclu√≠da), antes de retornar uma resposta para a Classe que acionou o M√©todo.

**Linha 47:** Verifica se o Objeto **buscaPostagem** e o **id da postagem** s√£o **nulos**. 

- Caso o usu√°rio digite um id que n√£o existe, o Objeto buscaPostagem ser√° nulo e o M√©todo de busca emitir√° uma mensagem de erro. 
- Caso o usu√°rio n√£o informe o valor do Atributo id no Objeto postagem dentro do JSON, que foi enviado no Corpo da Requisi√ß√£o, o M√©todo de busca tamb√©m emitir√° uma mensagem de erro. 

**Linha 48:** Se o Objeto buscaPostagem ou o Atributo id do Objeto postagem forem nulos, ser√° retornado o HTTP Status **NOT FOUND ü°™ 404** (N√£o Encontrado!).

**Linha 50:** Retorna a execu√ß√£o do M√©todo **save()**, do objeto **postagemRepository** (Inje√ß√£o de Depend√™ncia). O resultado da execu√ß√£o do M√©todo **save()**, ser√° um Objeto da Classe Postagem atualizado no Banco de dados, na tabela **tb_postagens**. 

Observe que na instru√ß√£o **return** foi inserido o comando **await** (aguarde), que na pr√°tica significa espere que a **Promise** seja resolvida (o Objeto postagem seja atualizado), antes de retornar uma resposta para a Classe que acionou o M√©todo.

> O M√©todo **save()**, da Classe Repository, serve tanto para persistir um novo Objeto, quanto para atualizar os dados de um novo Objeto no Banco de dados da aplica√ß√£o. Para diferenciar qual opera√ß√£o ser√° efetuada, o M√©todo save() utiliza a seguinte regra:
>
> - Se o Objeto n√£o possui um id, a opera√ß√£o ser√° de persist√™ncia (Criar um novo Objeto)
> - Se o Objeto possui um id, a opera√ß√£o ser√° de atualiza√ß√£o (Atualizar todos os dados de um Objeto existente)

No caso de uma atualiza√ß√£o dos dados, o retorno esperado do M√©todo **save()** ser√° a confirma√ß√£o do Objeto persistido com as atualiza√ß√µes, no formato JSON, como mostra o exemplo abaixo:

```json
{
    "id" : 3,
    "titulo" : "Postagem 03 atualizada",
    "texto" : "Texto da Postagem 03 atualizado"
    "data": "2022-07-13T18:13:48.167Z"
}
```

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/providers" target="_blank"><b>Documenta√ß√£o: <i>Provedores - Classe de Servi√ßo</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/fundamentals/custom-providers" target="_blank"><b>Documenta√ß√£o: <i>Provedores Customizados - Classe de Servi√ßo</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/OtnA0bd.png" title="source: imgur.com" width="25px"/> <a href="https://typeorm.io/find-options" target="_blank"><b>Documenta√ß√£o: <i>TypeORM - M√©todo de busca find()</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/r9lrbPG.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank"><b>Documenta√ß√£o: Promise</b></a></div>

<div align="left"><img src="https://i.imgur.com/r9lrbPG.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/JavaScript/Reference/Operators/async_function" target="_blank"><b>Documenta√ß√£o: Async</b></a></div>

<div align="left"><img src="https://i.imgur.com/r9lrbPG.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/JavaScript/Reference/Operators/await" target="_blank"><b>Documenta√ß√£o: Await</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/07_Cadastrar_Atualizar_Postagem/blogpessoal/src/postagem/services/postagem.service.ts" target="_blank"><b>C√≥digo fonte da Classe PostagemService</b></a></div>

<br />

<h2>üë£ Passo 02 - Criar o M√©todo update na Classe PostagemController</h2>



Vamos implementar o M√©todo **update(@Body() postagem: Postagem)** na Classe PostagemController, que tem como objetivo executar o M√©todo com o mesmo nome na Classe de Servi√ßo PostagemService. 

1. Abra a Classe **PostagemController**, localizada na pasta **src/postagem/controllers**.

<div align="center"><img src="https://i.imgur.com/HaoDWSZ.png?1" title="source: imgur.com" /></div>

2. Insira o c√≥digo depois do M√©todo **create(@Body() postagem: Postagem)**.

<div align="left"><img src="https://i.imgur.com/CsgqXzI.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 33:** O decorador **@Put()** mapeia todas as Requisi√ß√µes **HTTP PUT**, enviadas para um endere√ßo espec√≠fico, chamado **endpoint**, dentro do M√≥dulo Postagem, para um M√©todo espec√≠fico, que responder√° a Requisi√ß√£o, ou seja, ele indica que o M√©todo **update(@Body() postagem: Postagem)**, responder√° a todas as requisi√ß√µes do tipo **HTTP PUT**, enviadas no endere√ßo **http://localhost:4000/postagens/**.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ATEN√á√ÉO:** *O Endere√ßo do endpoint do M√©todo update ser√° igual ao endere√ßo dos M√©todos findAll e create. Como os verbos HTTP dos tr√™s M√©todos s√£o diferentes, o mesmo endere√ßo pode ser utilizado.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linha 34:** O decorador **@HttpCode(HttpStatus.OK)** indica que o M√©todo **update(@Body() postagem: Postagem)**, ter√° como **Resposta HTTP** padr√£o **OK ü°™ 200**, ou seja, quando a Resposta da Requisi√ß√£o for positiva, ser√° retornado o **HTTP Status OK ü°™ 200**. Caso a Resposta seja negativa (algo deu errado), a Resposta depender√° do erro.

- **HTTP Status BAD REQUEST ü°™ 400**, caso seja um erro de valida√ß√£o de algum atributo do objeto
- **HTTP Status NOT FOUND ü°™ 404**, caso o objeto n√£o seja encontrado
- **HTTP Status INTERNAL SERVER ERROR ü°™ 500**, caso ocorra algum erro no c√≥digo ou no servidor

**Linha 35:** Criamos o M√©todo **update(@Body() postagem: Postagem)**, que promete retornar uma **Promise**, que ser√° enviada pela Classe PostagemService, contendo um Objeto da Classe Postagem atualizado. 

**@Body():** Este decorador **acessa o Objeto postagem enviado no corpo da Requisi√ß√£o e insere no Objeto postagem** (par√¢metro) do M√©todo **update(@Body() postagem: Postagem)**;

**Linha 36:** Executa o m√©todo **update(postagem: Postagem)**, **M√©todo da Classe PostagemService**, que retornar√° **o Objeto da Classe Postagem** atualizado no Banco de dados. 

3. Ap√≥s a implementa√ß√£o do M√©todo **update(@Body() postagem: Postagem)**, observe que a linha 1 do c√≥digo ser√° atualizada com uma nova importa√ß√£o, como mostra a figura abaixo (indicado em amarelo):

<div align="left"><img src="https://i.imgur.com/PE1Vfqr.png" title="source: imgur.com" /></div>

<br />

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href=" https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Methods" target="_blank"><b>Documenta√ß√£o: HTTP Request Methods</b></a></div>

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href=" https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Status" target="_blank"><b>Documenta√ß√£o: HTTP Status Code</b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/controllers" target="_blank"><b>Documenta√ß√£o: <i>Classe Controladora</i></b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/providers" target="_blank"><b>Documenta√ß√£o: <i>Provedores - Classe Controladora</i></b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="35px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/07_Cadastrar_Atualizar_Postagem/blogpessoal/src/postagem/controllers/postagem.controller.ts" target="_blank"><b>C√≥digo fonte da Classe PostagemController</b></a></div>

<br />

<h2>üë£ Passo 03 - Executar o projeto</h2>



1. Verifique se voc√™ est√° dentro da pasta do projeto, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/JgNkmDv.png" title="source: imgur.com" /></div>

2. Digite o comando ***npm run start:dev***, para compilar e executar o nosso projeto **blogpessoal**, caso n√£o esteja em execu√ß√£o. 

```bash
npm run start:dev
```

3. Se tudo deu certo, observe na imagem abaixo, na regi√£o indicada em amarelo, que o endpoint do tipo **POST**, apontando para o caminho (rota) **/postagens**, foi disponibilizado.

<div align="center"><img src="https://i.imgur.com/avX3X6b.png" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 04 - Testar no Insomnia o M√©todo update</h2>



Agora vamos criar a Requisi√ß√£o para o **M√©todo update(postagem: Postagem)**:

1. Clique com o bot√£o direito do mouse sobre a **Pasta Postagem** para abrir o menu e clique na op√ß√£o **New HTTP Request**.

<div align="center"><img src="https://i.imgur.com/KvRI8b2.png" title="source: imgur.com" /></div>

2.  Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Postagem**.

<div align="center"><img src="https://i.imgur.com/CA70WQn.png" title="source: imgur.com" /></div>

3. D√™ um duplo clique sobre a nova Requisi√ß√£o (**New Request**), informe o nome da Requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/ZQKmphk.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**PUT**) na Requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/z6dWHYj.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Postagem no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a Requisi√ß√£o conforme a imagem abaixo: 

<div align="center"><img src="https://i.imgur.com/yhn142h.png" title="source: imgur.com" /></div>

4. No item marcado em amarelo na imagem acima, informe o endere√ßo (endpoint)) da Requisi√ß√£o. A requisi√ß√£o **Editar Postagem** foi configurada da seguinte maneira:

   - A primeira parte do endere√ßo (http://localhost:4000) √© o endere√ßo do nosso servidor local. Quando a aplica√ß√£o estiver na nuvem, ele ser√° substitu√≠do pelo endere√ßo da nuvem.
   - A segunda parte do endere√ßo √© o **endpoint** configurado no decorador ***@Controller***, em nosso caso **/postagens**.  

5. Na guia **JSON**, precisamos inserir um **JSON** com os dados que ser√£o inseridos na nova postagem. Lembrando que no padr√£o JSON: **o texto antes dos 2 pontos** (:) √© o **atributo** da Classe e **o texto depois dos 2 pontos** (:) √© o **dado** que ser√° cadastrado no atributo.  Os atributos s√£o separados por virgula, como mostra a imagem acima.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** Observe que no m√©todo **PUT √© necess√°rio enviar o atributo id** no JSON para identificar a Postagem que ser√° atualizada. A data n√£o precisa ser enviada, porqu√™ ela ser√° atualizada pela pr√≥pria aplica√ß√£o.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

6. Para testar a requisi√ß√£o, com a aplica√ß√£o rodando, clique no bot√£o <img src="https://i.imgur.com/sy0V8Nx.png" title="source: imgur.com" width="60px"/>.

7. O resultado da requisi√ß√£o voc√™ confere na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/cX3ZGv8.png" title="source: imgur.com" /></div>

8. Observe que a aplica√ß√£o retorna al√©m dos dados que foram atualizados no Banco de dados, ela tamb√©m retorna um **HTTP Status 200 ü°™ OK** (indicado em verde na imagem acima). Este Status indica que a Requisi√ß√£o foi bem sucedida!

9. Caso a Postagem n√£o seja encontrada, ser√° retornado o **HTTP Status 404 ü°™ NOT_FOUND**, ou seja, a postagem n√£o foi encontrada, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/ygGQ0TE.png" title="source: imgur.com" /></div>

10. Caso os Atributos **titulo** ou **texto** sejam nulos ou em branco (indicado em amarelo), a aplica√ß√£o retornar√° o **HTTP Status 400 ü°™ BAD_REQUEST** (indicado em verde), devido a valida√ß√£o que foi inserida na Classe Postagem (**@IsNotEmpty**), como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/NrDMu75.png" title="source: imgur.com" /></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/tree/07_Cadastrar_Atualizar_Postagem" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
