<h1>Projeto 02 - Blog Pessoal - M√≥dulo Usu√°rio - Parte 02</h1>

O que veremos por aqui:

1. Criar a Classe UsuarioService
2. Atualizar a Classe Postagem Service
3. Criar a Classe UsuarioController
4. Registrar as Classes UsuarioService e UsuarioController na Classe M√≥dulo UsuarioModule
5. Testar todos os M√©todos no Insomnia
6. Atualizar as Requisi√ß√µes Cadastrar e Atualizar Postagem

<h2>1. O M√≥dulo Usuario</h2>

Na etapa anterior, come√ßamos a construir o M√≥dulo Usuario e criamos o Relacionamento entre as Classes Usuario e Postagem. Veja o Diagrama de Classes abaixo: 

<div align="center"><img src="https://i.imgur.com/BOcR7EZ.jpg" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar o M√≥dulo Usuario. Todas as Classes constru√≠das no M√≥dulo Postagem dever√£o ser constru√≠das no M√≥dulo Usuario com as adapta√ß√µes pertinentes, especialmente nos M√©todos das Classes UsuarioService  e UsuarioController do M√≥dulo Usuario.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="150px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre como criar as Classes UsuarioService e UsuarioController, executar o projeto, entre outras, consulte a Documenta√ß√£o do M√≥dulo Postagem.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

Em rela√ß√£o ao Banco de dados **db_blogpessoal**, o DER ficar√° igual a imagem abaixo: 

<div align="center"><img src="https://i.imgur.com/Xu5hn4q.jpg" title="source: imgur.com" /></div>

<br />


<h2>üë£ Passo 01 - Criar a Classe UsuarioService</h2>

Vamos criar a pasta **services**, dentro do nosso **M√≥dulo Usuario** (pasta usuario):

1. Na pasta **usuario**, clique com o bot√£o direito do mouse e clique na op√ß√£o **New Folder** (Nova Pasta). 

2. Digite o nome da pasta (**services**) e pressione a tecla **enter** do seu teclado para concluir. 
2. A estrutura de pasta do M√≥dulo Usuario, ficar√° igual a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/g4MfnL6.png" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar a pasta services. Um erro muito comum √© criar a pasta services fora da pasta usuario.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

Na sequ√™ncia, vamos criar a Classe de Servi√ßo **UsuarioService** que chamaremos de **usuario.service.ts**

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe de Servi√ßo. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest (nome_do_modulo.tipo_da_classe.ts) para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta services**, que foi criada dentro da pasta **usuario**, como mostra a figura abaixo, e na sequ√™ncia clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**usuario.service.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/8s9o3ir.png" title="source: imgur.com" /></div>

Veja abaixo a implementa√ß√£o da Classe **UsuarioService**:

```typescript
import { HttpException, HttpStatus, Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Usuario } from '../entities/usuario.entity';
import { Bcrypt } from '../../auth/bcrypt/bcrypt';

@Injectable()
export class UsuarioService {
    constructor(
        @InjectRepository(Usuario)
        private usuarioRepository: Repository<Usuario>,
        private bcrypt: Bcrypt
    ) { }

    async findByUsuario(usuario: string): Promise<Usuario | undefined> {
        return await this.usuarioRepository.findOne({
            where: {
                usuario: usuario
            }
        })
    }

    async findAll(): Promise<Usuario[]> {
        return await this.usuarioRepository.find(
            {
                relations:{
                    postagem: true
                }
            }
        );

    }

    async findById(id: number): Promise<Usuario> {

        let usuario = await this.usuarioRepository.findOne({
            where: {
                id
            },
            relations: {
                postagem: true
            }
        });

        if (!usuario)
            throw new HttpException('Usuario n√£o encontrado!', HttpStatus.NOT_FOUND);

        return usuario;

    }

    async create(usuario: Usuario): Promise<Usuario> {
        
        let buscaUsuario = await this.findByUsuario(usuario.usuario);

        if (!buscaUsuario) {
            usuario.senha = await this.bcrypt.criptografarSenha(usuario.senha)
            return await this.usuarioRepository.save(usuario);
        }

        throw new HttpException("O Usuario ja existe!", HttpStatus.BAD_REQUEST);

    }

    async update(usuario: Usuario): Promise<Usuario> {

        let updateUsuario: Usuario = await this.findById(usuario.id);
        let buscaUsuario = await this.findByUsuario(usuario.usuario);

        if (!updateUsuario)
            throw new HttpException('Usu√°rio n√£o encontrado!', HttpStatus.NOT_FOUND);

        if (buscaUsuario && buscaUsuario.id !== usuario.id)
            throw new HttpException('Usu√°rio (e-mail) j√° Cadastrado!', HttpStatus.BAD_REQUEST);

        usuario.senha = await this.bcrypt.criptografarSenha(usuario.senha)
        return await this.usuarioRepository.save(usuario);

    }

}
```

Vamos analisar a implementa√ß√£o do c√≥digo, com foco nas diferen√ßas em rela√ß√£o aos M√≥dulos anteriores:

<h3> 1.1 M√©todo Constructor()</h3>

O M√©todo **Constructor()** recebe as **Inje√ß√µes de Depend√™ncia** necess√°rias para o desenvolvimento da Classe de Servi√ßo.

<div align="center"><img src="https://i.imgur.com/QnZtdHW.png" title="source: imgur.com" /></div>

**Linha 10:** Al√©m da Inje√ß√£o de Depend√™ncia usuarioRepository, o M√©todo receber√° tamb√©m uma Inje√ß√£o de Depend√™ncia da **Classe Bcrypt**, que foi criada como uma Classe de Servi√ßo no M√≥dulo Auth. Desta forma, poderemos criptografar o Atributo senha antes de persistir o Objeto da Classe Usuario no Banco de dados.



<h3> 1.2 M√©todo findByUsuario(usuario: string)</h3>

O M√©todo **findByUsuario(usuario: string)** ser√° respons√°vel por **checar se o Atributo usuario (e-mail)**, do Objeto Usuario **existe antes dele ser persistido, atualizado ou autenticado** (Login) na aplica√ß√£o. Este M√©todo √© essencial para o funcionamento do **Passport**.

<div align="center"><img src="https://i.imgur.com/wzuG4C2.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 15:** Criamos o M√©todo Ass√≠ncrono (async), chamado **findByUsuario(usuario: string)**, que promete retornar uma **Promise** contendo um Objeto da Classe Usuario (caso o Objeto Usuario seja encontrado) ou um Objeto do tipo **undefined** (indefinido, ou seja, o Objeto Usuario n√£o foi encontrado).

Observe que o M√©todo **findByUsuario(usuario: string)** possui um par√¢metro do tipo **string**, chamado **usuario**. Esta vari√°vel receber√° a string (e-mail), que voc√™ deseja procurar.  

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao implementar a  Classe Usuario Service. N√£o confunda o parametro usuario: string com o Objeto da Classe Usuario usuario: Usuario. Embora tenham o mesmo nome, eles n√£o s√£o a mesma coiosa.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linha 16:** Retorna a execu√ß√£o do M√©todo **findOne()**, da Interface **usuarioRepository**. O resultado da execu√ß√£o do M√©todo **findOne()**, ser√° um Objeto Usuario espec√≠fico, selecionado de acordo com o(s) crit√©rio(s) da clausula where. Tra√ßando um paralelo com o MySQL, o M√©todo findOne() acima seria o equivalente a instru√ß√£o: `SELECT * FROM tb_usuarios where usuario = usuario_procurado;`.

**Linhas 17 e 18:** Declaramos a clausula where, com o crit√©rio usuario, ou seja, **localize o Objeto Usuario, cujo atributo usuario seja igual a string usuario (e-mail), enviado no par√¢metro do M√©todo findByUsuario(usuario: string)**.

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="30px"/> <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-0.html" target="_blank"><b>Documenta√ß√£o: TypeScript undefined (tipo Indefinido)</b></a></div>

<div align="left"><img src="https://i.imgur.com/OtnA0bd.png" title="source: imgur.com" width="25px"/> <a href="https://typeorm.io/find-options" target="_blank"><b>Documenta√ß√£o: <i>TypeORM - M√©todo de busca find()</i></b></a></div>



<h3> 1.3 M√©todo create(usuario: Usuario)</h3>

O M√©todo **create(usuario: Usuario)** ser√° respons√°vel por **criar um novo Objeto da Classe Usuario**. Este M√©todo √© essencial para o funcionamento do **Passport**, porqu√™ sem o usu√°rio e a senha, n√£o ser√° poss√≠vel acessar aplica√ß√£o. Al√©m disso, antes de persistir os dados do usu√°rio, ele verificar√° se o usu√°rio (e-mail) existe, para impedir a duplica√ß√£o e aplicar√° a criptografia Bcrypt na senha, para protege-la.

<div align="center"><img src="https://i.imgur.com/iubMaTb.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 52:** Criamos o M√©todo Ass√≠ncrono (async), chamado **create(usuario: Usuario)**, que promete retornar uma **Promise** contendo um Objeto da Classe Usuario, que foi persistido no Banco de dados da aplica√ß√£o.

Observe que o M√©todo **create(usuario: Usuario)** possui um par√¢metro do tipo **Usuario**, chamado **usuario**. Esta vari√°vel receber√° um Objeto da Classe Usuario, que ser√° enviado  no Corpo da Requisi√ß√£o (Request Body), conforme as regras definidas na  Entidade Usuario (Tamanho, Pode ser Nulo, Pode ser vazio, entre outras). O Objeto usuario ser√° enviado pelo M√©todo da **Classe UsuarioController**, atrav√©s de um **JSON**, semelhante ao exemplo abaixo:

```json
{
    "nome": "Administrador",
    "usuario": "admin@email.com.br",
    "senha": "admin123",
    "foto": "https://i.imgur.com/JR7kUFU.jpg"
}
```

Observe que todos os Atributos ser√£o enviados, **exceto o id**, porqu√™ ele **ser√° atribu√≠do pelo Banco de dados** ap√≥s o Objeto ser persistido.

**Linha 54:** Criamos um Objeto da Classe Usuario, chamado **buscaUsuario**, para receber o resultado da execu√ß√£o do M√©todo **findByUsuario(usuario: string)**, da Classe **UsuarioService**. O objetivo √© checar se o Atributo usuario, do Objeto da Classe Usuario, que ser√° persistido j√° existe.  

**Linha 56:** Verifica se o Objeto **buscaUsuario √© nulo**, ou seja, se o Objeto da Classe Usuario n√£o existe. Caso ele n√£o exista, ele poder√° ser persistido no Banco de dados.

**Linha 57:** Atrav√©s do **M√©todo criptografarSenha(senha: string)**, da Classe Bcrypt, do M√≥dulo Auth, vamos criptografar a senha do Objeto usuario antes de persistir o Objeto no Banco de dados. Observe que a senha n√£o criptografada (digitada no login) ser√° substitu√≠da pela senha criptografada. 

**Linha 58:** Retorna a execu√ß√£o do M√©todo **save()**, da Interface **usuarioRepository**. O resultado da execu√ß√£o do M√©todo **save()**, ser√° um Objeto da Classe Postagem persistido no Banco de dados, na tabela **tb_usuarios**.

No caso de uma persist√™ncia dos dados, o retorno esperado do M√©todo **save()** ser√° a confirma√ß√£o do Objeto persistido, no formato JSON, como mostra o exemplo abaixo:

```json
{
    "id": 1,
    "nome": "Administrador",
    "usuario": "admin@email.com.br",
    "senha": "$2b$10$0VX70x6YbPwsXPZQq6TqL.inlrXIXDKC8qidomM8Vn8JLuglXzWEC",
    "foto": "https://i.imgur.com/JR7kUFU.jpg"
}
```

Observe que a senha est√° criptografada.

**Linha 61:** Se o Objeto **buscaUsuario** n√£o for nulo, ou seja, o usu√°rio foi encontrado, ser√° retornado o HTTP Status **BAD REQUEST ü°™ 400** (Usu√°rio Encontrado!).



<h3> 1.4 M√©todo update(usuario: Usuario)</h3>

O M√©todo **update(usuario: Usuario)** ser√° respons√°vel por **atualizar os dados de um Objeto da Classe Usuario** persistido no Banco de dados. Este M√©todo √© muito √∫til para alterar a senha ou qualquer outro Atributo do Objeto Usuario, exceto o id.

<div align="center"><img src="https://i.imgur.com/rD4sq2g.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 65:** Criamos o M√©todo Ass√≠ncrono (async), chamado **update(usuario: Usuario)**, que promete retornar uma **Promise** contendo um Objeto da Classe Usuario, que foi atualizado no Banco de dados da aplica√ß√£o.

Observe que o M√©todo **create(usuario: Usuario)** possui um par√¢metro do tipo **Usuario**, chamado **usuario**. Esta vari√°vel receber√° um Objeto da Classe Usuario, que ser√° enviado  no Corpo da Requisi√ß√£o (Request Body), conforme as regras definidas na  Entidade Usuario (Tamanho, Pode ser Nulo, Pode ser vazio, entre outras). O Objeto usuario ser√° enviado pelo M√©todo da **Classe UsuarioController**, atrav√©s de um **JSON**, semelhante ao exemplo abaixo:

```json
{
    "id": 1,
    "nome": "Administrador da Aplica√ß√£o",
    "usuario": "admin@email.com.br",
    "senha": "admin123",
    "foto": "https://i.imgur.com/JR7kUFU.jpg"
}
```

Observe que todos os Atributos ser√£o enviados, **inclusive o id**, porqu√™ ele **ser√° utilizado para identificar o Objeto Usuario que ser√° atualizado**.

**Linha 67:** Criamos um Objeto da Classe Usuario, chamado **updateUsuario**, para receber o resultado da execu√ß√£o do M√©todo **findById(id: number)**, da Classe **UsuarioService**. O objetivo √© checar se o Objeto Usuario que ser√° atualizado existe, atrav√©s da busca pelo id.

**Linha 68:** Criamos um Objeto da Classe Usuario, chamado **buscaUsuario**, para receber o resultado da execu√ß√£o do M√©todo **findByUsuario(usuario: string)**, da Classe **UsuarioService**. O objetivo √© checar se o Atributo usuario, do Objeto da Classe Usuario, que ser√° persistido j√° existe.  

**Linha 70:** Verifica se o Objeto **updateUsuario √© nulo**, ou seja, se o Objeto da Classe Usuario n√£o existe. Caso ele n√£o exista, ele n√£o poder√° ser atualizado no Banco de dados.

**Linha 71:** Se o Objeto **updateUsuario** for nulo, ser√° retornado o HTTP Status **NOT FOUND ü°™ 404** (N√£o Encontrado!).

**Linha 73:** Verifica se o Objeto **buscaUsuario n√£o √© nulo** e se o **Atributo id do Objeto buscaUsuario (Objeto encontrado no Banco de dados)** √© diferente do **Atributo id do Objeto usuario (Objeto enviado na Requisi√ß√£o)**. 

A primeira condi√ß√£o do if, verifica se o usu√°rio digitou no Atributo usuario, um e-mail que j√° foi persistido no Banco de dados. Caso este e-mail exista, o Objeto **buscaUsuario n√£o ser√° nulo**. 

Observe que **n√£o basta apenas checar a exist√™ncia do e-mail para permitir a atualiza√ß√£o**, precisamos **verificar tamb√©m se o e-mail pertence ao usu√°rio que ser√° atualizado**, caso contr√°rio teremos uma **duplica√ß√£o de usu√°rio (e-mail)**. 

A segunda condi√ß√£o do if, verifica se **o Atributo id enviado no corpo da requisi√ß√£o √© diferente do Atributo id, que foi encontrado no Banco de dados**. Caso seja diferente, significa que o e-mail existe, mas **n√£o pertence ao Objeto que ser√° atualizado**, logo a atualiza√ß√£o n√£o pode ser efetuada.

**Linha 74:** Se as 2 condi√ß√µes da linha 73 forem satisfeitas, ou seja, o usu√°rio foi encontrado e pertence a outro Usuario, ser√° retornado o HTTP Status **BAD REQUEST ü°™ 400** (Usu√°rio j√° Existe!).

**Linha 76:** Caso contr√°rio, atrav√©s do **M√©todo criptografarSenha(senha: string)**, da Classe Bcrypt, do M√≥dulo Auth, vamos criptografar a senha do Objeto usuario antes de persistir o Objeto no Banco de dados. Observe que a senha n√£o criptografada (digitada no login) ser√° substitu√≠da pela senha criptografada. 

**Linha 77:** Retorna a execu√ß√£o do M√©todo **save()**, da Interface **usuarioRepository**. O resultado da execu√ß√£o do M√©todo **save()**, ser√° um Objeto da Classe Usuario atualizado no Banco de dados, na tabela **tb_usuarios**.

No caso de uma atualiza√ß√£o dos dados, o retorno esperado do M√©todo **save()** ser√° a confirma√ß√£o do Objeto persistido com as atualiza√ß√µes, no formato JSON, como mostra o exemplo abaixo:

```json
{
    "id": 1,
    "nome": "Administrador da Aplica√ß√£o",
    "usuario": "admin@email.com.br",
    "senha": "$2b$10$mXsoRRRUT1moBDzTZfhyKuKApUHFugyRDqAdQEPumnrwGrmXuzeNy",
    "foto": "https://i.imgur.com/JR7kUFU.jpg"
}
```

Observe que a senha est√° criptografada, entretanto a hash da criptografia est√° diferente, porqu√™ mesmo a senha sendo a mesma, cada vez que o **M√©todo criptografarSenha(senha: string)** √© executado, uma hash diferente √© gerada.

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/12_Recurso_Usuario/blogpessoal/src/usuario/services/usuario.service.ts" target="_blank"><b>C√≥digo fonte da Classe UsuarioService</b></a></div>

<br />

<h2>üë£ Passo 02 - Atualizar a Classe PostagemService</h2>

Da mesma forma que adicionamos o comando **relations na Classe UsuarioService**, tamb√©m iremos **atualizar o comando relations na Classe PostagemService**, nos M√©todos **findAll(), findById(id: number) e findByTitulo(titulo: string)**, adicionando o Objeto da Classe usuario, como mostra imagem abaixo:

<div align="center"><img src="https://i.imgur.com/WnaJZyf.png" title="source: imgur.com" /></div>

Observe que acrescentamos o atributo usuario logo abaixo do Objeto tema, separados por uma virgula.

Desta forma, ao executar os M√©todos  **findAll(), findById(id: number) e findByTitulo(titulo: string)**, os Objetos da Classe Postagem passar√£o a exibir os Objetos das Classes Tema e Usuario associados, semelhante ao exemplo abaixo:

```json
{
    "id": 4,
    "titulo": "Minha Postagem 04",
        "texto": "Texto da Postagem 04",
        "data": "2022-07-14T11:51:00.954Z",
    "tema": {
        "id": 1,
        "descricao": "Usuario 01"
    },
        "usuario": {
        "id": 1,
        "nome": "Administrador",
        "usuario": "admin@email.com.br",
        "senha": "$2b$10$0VX70x6YbPwsXPZQq6TqL.inlrXIXDKC8qidomM8Vn8JLuglXzWEC",
        "foto": "https://i.imgur.com/JR7kUFU.jpg"
    }
}
```

Veja abaixo a implementa√ß√£o atualizada da Classe **PostagemService**:

```typescript
import { HttpException, HttpStatus, Injectable } from "@nestjs/common";
import { InjectRepository } from "@nestjs/typeorm";
import { DeleteResult, ILike, Repository } from "typeorm";
import { TemaService } from "../../tema/services/tema.service";
import { Postagem } from "../entities/postagem.entity";

@Injectable()
export class PostagemService {
    constructor(
        @InjectRepository(Postagem)
        private postagemRepository: Repository<Postagem>,
        private temaService:TemaService
    ) { }

    async findAll(): Promise<Postagem[]> {
        return await this.postagemRepository.find({
            relations:{
                tema: true,
                usuario: true
            }
        });
    }

    async findById(id: number): Promise<Postagem> {

        let postagem = await this.postagemRepository.findOne({
            where: {
                id
            },
            relations:{
                tema: true,
                usuario: true
            }
        });

        if (!postagem)
            throw new HttpException('Postagem n√£o encontrada!', HttpStatus.NOT_FOUND);

        return postagem;
    }

    async findByTitulo(titulo: string): Promise<Postagem[]> {
        return await this.postagemRepository.find({
            where:{
                titulo: ILike(`%${titulo}%`)
            },
            relations:{
                tema: true,
                usuario: true
            }
        })
    }

    async create(postagem: Postagem): Promise<Postagem> {
       
        if (postagem.tema){
            
            let tema = await this.temaService.findById(postagem.tema.id)

            if (!tema)
                throw new HttpException('Tema n√£o encontrado!', HttpStatus.NOT_FOUND);
            
            return await this.postagemRepository.save(postagem);

        }

        return await this.postagemRepository.save(postagem);
    }

    async update(postagem: Postagem): Promise<Postagem> {
        
        let buscaPostagem: Postagem = await this.findById(postagem.id);

        if (!buscaPostagem || !postagem.id)
            throw new HttpException('Postagem n√£o encontrada!', HttpStatus.NOT_FOUND);

        if (postagem.tema){
            
            let tema = await this.temaService.findById(postagem.tema.id)
                
            if (!tema)
                throw new HttpException('Tema n√£o encontrado!', HttpStatus.NOT_FOUND);
                
            return await this.postagemRepository.save(postagem);
    
        }
        
        return await this.postagemRepository.save(postagem);
    }

    async delete(id: number): Promise<DeleteResult> {
        
        let buscaPostagem = await this.findById(id);

        if (!buscaPostagem)
            throw new HttpException('Postagem n√£o encontrada!', HttpStatus.NOT_FOUND);

        return await this.postagemRepository.delete(id);

    }

}
```

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/12_Recurso_Usuario/blogpessoal/src/postagem/services/postagem.service.ts" target="_blank"><b>C√≥digo fonte da Classe PostagemService</b></a></div>

<br />

<h2>üë£ Passo 03 - Criar a Classe UsuarioController</h2>

Vamos criar a pasta **controllers**, dentro do nosso **M√≥dulo Usuario** (pasta usuario):

1. Na pasta **usuario**, clique com o bot√£o direito do mouse e clique na op√ß√£o **New Folder** (Nova Pasta). 

2. Digite o nome da pasta (**controllers**) e pressione a tecla **enter** do seu teclado para concluir. 
2. A estrutura de pasta do M√≥dulo Usuario, ficar√° igual a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/PeQQ3Vq.png" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar a pasta controllers. Um erro muito comum √© criar a pasta controllers fora da pasta usuario.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

Na sequ√™ncia, vamos criar a Classe Controladora **UsuarioController** que chamaremos de **usuario.controller.ts**.

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="320px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe de Servi√ßo. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest (nome_do_modulo.tipo_da_classe.ts) para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **pasta controllers**, que foi criada dentro da pasta **usuario**, como mostra a figura abaixo, e clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**usuario.controller.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/DPeGvxz.png" title="source: imgur.com" /></div>

Veja abaixo a implementa√ß√£o da Classe **UsuarioController**:

```typescript
import { Body, Controller, Get, HttpCode, HttpStatus, Post, Put } from "@nestjs/common";
import { Usuario } from "../entities/usuario.entity";
import { UsuarioService } from "../services/usuario.service";

@Controller("/usuarios")
export class UsuarioController {
    constructor(private readonly usuarioService: UsuarioService) { }

    @Get('/all')
    @HttpCode(HttpStatus.OK)
    findAll(): Promise<Usuario[]> {
        return this.usuarioService.findAll();
    }

    @HttpCode(HttpStatus.CREATED)
    @Post('/cadastrar')
    async create(@Body() usuario: Usuario): Promise<Usuario> {
        return await this.usuarioService.create(usuario);
    }

    @Put('/atualizar')
    @HttpCode(HttpStatus.OK)
    async update(@Body() usuario: Usuario): Promise<Usuario> {
        return this.usuarioService.update(usuario);
    }

}
```
Observe que a implementa√ß√£o √© semelhante as Classes **PostagemController** e **TemaController**, entretanto **implementamos apenas os M√©todos findAll(), create() e update()**. Os demais M√©todos do M√≥dulo Usu√°rio n√£o precisam ser expostos na Classe Controladora.

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/12_Recurso_Usuario/blogpessoal/src/usuario/controllers/usuario.controller.ts" target="_blank"><b>C√≥digo fonte da Classe UsuarioController</b></a></div>

<br />

<h2>üë£ Passo 04 - Registrar as Classes UsuarioService e UsuarioController na Classe UsuarioModule</h2>

Na sequ√™ncia, vamos registrar as nossas Classes **UsuarioService** e **UsuarioController**, no M√≥dulo **UsuarioModule**. Esse passo √© fundamental para o correto funcionamento da nossa aplica√ß√£o.

1. Abra a Classe **UsuarioModule**, localizada na pasta **usuario**, conforme indicada na imagem abaixo:

   <div align="center"><img src="https://i.imgur.com/5eD78El.png" title="source: imgur.com" /></div>

2. Implemente as altera√ß√µes, indicadas pelas setas na imagem abaixo:

 <div align="left"><img src="https://i.imgur.com/28G31Tl.png" title="source: imgur.com" /></div>

Vamos analisar as altera√ß√µes no c√≥digo:

**Linha 10:** No array **providers** vamos adicionar as Classes **UsuarioService** do **M√≥dulo Usuario** e **Bcrypt** do **M√≥dulo Auth**. Desta forma a Classe de Servi√ßo e a Classe Brypt poder√£o ser injetadas em outras Classes dentro do M√≥dulo Usuario.

**Linha 11:** No array **controllers** vamos adicionar a **Classe UsuarioController** do **M√≥dulo Usuario**. Desta forma os endpoints da Classe Controladora estar√£o dispon√≠veis para receber Requisi√ß√µes HTTP.

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao Registrar novas Classes no M√≥dulo. Observe que ap√≥s registrar uma nova Classe, novas importa√ß√µes de Classes ser√£o necess√°rias nas primeiras linhas da Classe UsuarioModule.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/12_Recurso_Usuario/blogpessoal/src/usuario/usuario.module.ts" target="_blank"><b>C√≥digo fonte da Classe UsuarioModule</b></a></div>

<br />

<h2>üë£ Passo 05 - Executar o projeto</h2>

1. Verifique se voc√™ est√° dentro da pasta do projeto, como mostra a figura abaixo:


<div align="center"><img src="https://i.imgur.com/67GK3fX.png" title="source: imgur.com" /></div>

2. Digite o comando ***npm run start:dev***, para compilar e executar o nosso projeto **blogpessoal**, caso n√£o esteja em execu√ß√£o. 

```bash
npm run start:dev
```

3. Se tudo deu certo, o resultado ser√° semelhante ao da figura abaixo:

<div align="center"><img src="https://i.imgur.com/xymrXM9.png" title="source: imgur.com" /></div>

4.Observe que os 3 endpoints do **M√≥dulo Usuario** foram disponibilizados no endere√ßo **/usuarios** 

<br />

<h2>üë£ Passo 06 - Testar o M√≥dulo Usuario no Insomnia</h2>

Vamos criar no Insomnia todas as requisi√ß√µes necess√°rias para testar os 3 M√©todos do M√≥dulo Usuario. Veja abaixo como ficam as requisi√ß√µes para testar o M√≥dulo Usuario:

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre como criar as Requisi√ß√µes, consulte a Documenta√ß√£o dos M√≥dulos Postagem e Tema.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="120px"/> | <div align="left"> **ATEN√á√ÉO:** *Depois de criar o Relacionamento entre Classes, todas as Consultas dos M√≥dulos Postagem, Tema e Usuario trar√£o os Objetos associados.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<h3>6.1. Criando a Pasta Usuario</h3>

Vamos criar dentro da **Collection Blog Pessoal** a **Pasta Usuario**, que guardar√° todas as requisi√ß√µes do **Recurso Usuario**.

1. Na **Collection Blog Pessoal**, clique no bot√£o <img src="https://i.imgur.com/Igkx9ev.png" title="source: imgur.com" width="25px"/>. No menu que ser√° aberto, clique na op√ß√£o **New Folder**.

<div align="center"><img src="https://i.imgur.com/44vqfU9.png" title="source: imgur.com" width="50%"/></div>

2. Na janela que ser√° aberta, informe o nome da pasta (**Usuario**) e clique no bot√£o **Create** para concluir. 

<div align="center"><img src="https://i.imgur.com/zj0NKNS.png" title="source: imgur.com" width="90%"/></div>

<h3>6.2. Criando a  Requisi√ß√£o - Cadastrar Usuario</h3>

Vamos come√ßar pela requisi√ß√£o Cadastrar Usuario porqu√™ sem um usu√°rio cadastrado n√£o ser√° poss√≠vel autenticar (logar) no sisusuario e acessar os demais endpoints.

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/BIsfvDG.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**POST**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/TLBY2tJ.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/d2gv8YO.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo Post o Corpo da requisi√ß√£o (Request Body) deve ser preenchido com um JSON contendo o nome, o usuario(e-mail), a senha e a foto(link), que vc deseja persistir no Banco de dados.

9. Observe que depois de persistir os dados do usuario, a aplica√ß√£o retornar√° a senha criptografada.

<div align="center"><img src="https://i.imgur.com/75wANgh.png" title="source: imgur.com" /></div>

<h3>6.3. Criando a  Requisi√ß√£o - Consultar todos os Usuarios - findAll()</h3>

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Request**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/Veedyux.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**GET**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/mWPpKHD.png" title="source: imgur.com" /></div>

5. Configure a requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/djGk2ZU.png" title="source: imgur.com" /></div>

6. O resultado da requisi√ß√£o voc√™ confere na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/9l6RX5s.png" title="source: imgur.com" /></div>

7. Observe que ser√° exibido no final do Objeto Usuario o **array postagem**. Caso o usu√°rio crie novas postagens, elas ser√£o exibidas dentro deste array.

<h3>6.4. Criando a  Requisi√ß√£o - Atualizar Usu√°rio</h3>

1. Clique com o bot√£o direito do mouse sobre a **Pasta Usuario** para abrir o menu e clique na op√ß√£o **New Requisi√ß√£o**.

2. Ser√° criada uma nova Requisi√ß√£o (New Request) dentro da pasta **Usuario**.

3. D√™ um duplo clique sobre a nova requisi√ß√£o (**New Request**), informe o nome da requisi√ß√£o (indicado na imagem abaixo na cor amarela) e pressione a tecla **enter** do seu teclado.

<div align="center"><img src="https://i.imgur.com/dE5zZge.png" title="source: imgur.com" /></div>

4. Selecione o M√©todo HTTP que ser√° utilizado (**PUT**) na requisi√ß√£o, indicado na imagem abaixo na cor verde. 

<div align="center"><img src="https://i.imgur.com/z6dWHYj.png" title="source: imgur.com" /></div>

5. No item **Body**, vamos alterar para **JSON**, como mostra a imagem abaixo. Desta forma poderemos enviar os dados do Objeto Usuario no Corpo da Requisi√ß√£o, no formato JSON.

<div align="center"><img src="https://i.imgur.com/PxOpzFd.png" title="source: imgur.com" /></div>

6. Observe que o item **Body** ser√° renomeado para **JSON**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/8hDNIbh.png" title="source: imgur.com" /></div>

7. Configure o endere√ßo da requisi√ß√£o conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/CDzrTjG.png" title="source: imgur.com" /></div>

8. Observe que na requisi√ß√£o do tipo **PUT** o Corpo da requisi√ß√£o (Request Body) deve ser preenchido com um JSON contendo o Id, o nome, o usuario (e-mail), a senha e a foto(link) que vc deseja atualizar no Banco de dados.

9. O resultado da Requisi√ß√£o voc√™ confere na imagem abaixo:


<div align="center"><img src="https://i.imgur.com/EBmK0F7.png" title="source: imgur.com" width="90%"/></div>

<br />

<h2>üë£ Passo 07 - Atualizar as Requisi√ß√µes Cadastrar e Atualizar Postagem no Insomnia</h2>

Como habilitamos o Relacionamento entre as Classes Postagem e Usuario, para Cadastrarmos e Alterarmos as Postagens vamos precisar atender alguns requisitos:

- O Tema e o Usuario devem ser persistidos antes de criar a nova Postagem.
- Na requisi√ß√£o Cadastrar e Atualizar Postagem, o JSON enviado no Corpo da Requisi√ß√£o deve conter um Objeto da Classe Tema identificado apenas pelo **Atributo id** e um Objeto da Classe Usuario identificado apenas pelo **Atributo id**.

| <img src="https://i.imgur.com/nSpXEZ0.png" title="source: imgur.com" width="100px"/> | **IMPORTANTE:** *O Objeto da Classe Usuario n√£o ser√° validado na Classe PostagemService, da mesma forma que fizemos com o Tema, porqu√™ ao fazer o Login os dados do Objeto Usuario ficar√£o dispon√≠veis no LocalStorage (assunto para o front-end) do Navegador, validados pelo login.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<h3>7.1. Atualiza√ß√£o - Requisi√ß√£o Cadastrar Postagem</h3>

Vamos alterar o Corpo da requisi√ß√£o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/ygSi87a.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, al√©m do Objeto da Classe Tema, que foi inserido anteriormente.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATEN√á√ÉO:** *O Objeto Usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisi√ß√£o Cadastrar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<h3>7.2. Atualiza√ß√£o - Requisi√ß√£o Atualizar Postagem</h3>

Vamos alterar o Corpo da requisi√ß√£o (Body), conforme a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/iWqujdB.png" title="source: imgur.com" /></div>

Observe que foi inserido dentro do JSON um **Objeto da Classe Usuario**, chamado **usuario**, identificado apenas pelo **Atributo id**, al√©m do Objeto da Classe Tema, que foi inserido anteriormente.

N√£o esque√ßa de inserir o token no cabe√ßalho da requisi√ß√£o.

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | **ATEN√á√ÉO:** *O Objeto Usuario deve ser persistido no Banco de dados antes de ser inserido no JSON da requisi√ß√£o Atualizar Postagem.* |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="35px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/tree/12_Recurso_Usuario" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
