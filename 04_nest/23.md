<h1>Teste de Software - Jest - Testes do M√≥dulo Usu√°rio</h1>

<br />

<h2>üë£ Passo 01 - Implementar os Testes</h2>



Antes de come√ßar a implementar os M√©todos de teste, vamos criar 2 vari√°veis auxiliares (**token e usuarioId**), antes do M√©todo **beforeAll()**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/7cT7c03.png" title="source: imgur.com" /></div>

Na sequ√™ncia, vamos implementar os testes logo abaixo do M√©todo **afterAll()**:

<br />

<h3>M√©todo 01 - Deve criar um Usu√°rio</h3>



<div align="center"><img src="https://i.imgur.com/zSps0yp.png" title="source: imgur.com" /></div>

**Linha 35:** Definimos o Teste **Deve Cadastrar um novo Usu√°rio**, que foi criado atrav√©s do M√©todo **it()**, que indica que este M√©todo executar√° um teste.

**Linha 36:** Foi criada uma  **const**, chamada **resposta**, que receber√° a excu√ß√£o do M√©todo **request()**, que cria uma Requisi√ß√£o que ser√° enviada para a aplica√ß√£o, que foi gerada pelo Nest com o ambiente de testes.

**Linha 37:** Define que a Requisi√ß√£o ser√° do tipo **POST**, atrav√©s do M√©todo **post()**,  e enviar√° a Requisi√ß√£o para o endere√ßo do endpoint Cadastrar Usuario (**/usuarios/cadastrar**).

**Linhas 38 a 43:** Define os dados do Objeto Usuario, que ser√£o enviados no Corpo da Requisi√ß√£o, atrav√©s do M√©todo send(). Nesta etapa, o processo √© equivalente ao que o Insomnia faz em uma requisi√ß√£o do tipo **POST**: Transforma os atributos num objeto da Classe Usuario, que ser√° enviado no corpo da requisi√ß√£o (Request Body).

**Linha 44:** Atrav√©s do m√©todo <b>expect()</b>, da Biblioteca SuperTest, checaremos se a Resposta HTTP da Requisi√ß√£o (Response), √© a resposta esperada (**CREATED ü°™ 201**). Caso o HTTP Status da Resposta da Requisi√ß√£o seja 201, o **Teste Passa**. Caso seja outro  Status, o **Teste Falha**.

**Linha 46:** Vamos armazenar na vari√°vel **usuarioId** o Atributo **id** do usu√°rio cadastrado, porqu√™ iremos utilizar o id em outros testes. Para obter o id, vamos utilizar o M√©todo **resposta.body.id**, para extrair o Atributo id do Corpo da Resposta da Requisi√ß√£o.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/fundamentals/testing" target="_blank"><b>Documenta√ß√£o:  NestJS Testing</b></a></div>

<div align="left"><img src="https://i.imgur.com/3tsv1lE.png" title="source: imgur.com" width="30px"/> <a href="https://jestjs.io/pt-BR/docs/api" target="_blank"><b>Documenta√ß√£o: Jest</b></a></div>

<div align="left"><img src="https://i.imgur.com/kuK7aM3.png" title="source: imgur.com" width="35px"/> <a href="https://github.com/visionmedia/supertest#readme" target="_blank"><b>Documenta√ß√£o: Supertest</b></a></div>

<br />

<h3>M√©todo 02 - N√£o Deve Cadastrar um Usu√°rio Duplicado</h3>



<div align="center"><img src="https://i.imgur.com/irrry0w.png" title="source: imgur.com" /></div>

**Linha 50:** Definimos o Teste **N√£o Deve Cadastrar um Usu√°rio Duplicado**, que foi criado atrav√©s do M√©todo **it()**, que indica que este M√©todo executar√° um teste.

**Linha 51:** Neste M√©todo, como n√£o iremos extrair nenhum atributo do Corpo da Requisi√ß√£o, n√£o foi criado uma **const**. Utilizamos a palavra **return** que executar√° e retornar√° a Resposta do M√©todo **request()**, que cria uma Requisi√ß√£o que ser√° enviada para a aplica√ß√£o que foi gerada pelo Nest com o ambiente de testes.

**Linha 52:** Define que a Requisi√ß√£o ser√° do tipo **POST**, atrav√©s do M√©todo **post()**,  e enviar√° a Requisi√ß√£o para o endere√ßo do endpoint Cadastrar Usuario (**/usuarios/cadastrar**).

**Linhas 53 a 58:** Define os dados do Objeto Usuario que ser√£o enviados no Corpo da Requisi√ß√£o, atrav√©s do M√©todo send(). Nesta etapa, o processo √© equivalente ao que o Insomnia faz em uma requisi√ß√£o do tipo **POST**: Transforma os atributos num objeto da Classe Usuario, que ser√° enviado no corpo da requisi√ß√£o (Request Body).

<br />

| <img src="https://i.imgur.com/nSpXEZ0.png" title="source: imgur.com" width="250px"/> | <p align="justify"> Observe que neste m√©todo temos o objetivo de testar o Erro! (Usu√°rio Duplicado) e n√£o a persist√™ncia dos dados. Por este motivo enviamos o mesmo objeto que foi enviado no primeiro teste (Deve Cadastrar um Usuario) e verificamos se o aplicativo rejeita a persist√™ncia do mesmo objeto pela segunda vez (BAD REQUEST). </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linha 59:** Atrav√©s do m√©todo <b>expect()</b>, da Biblioteca SuperTest, checaremos se a Resposta HTTP da Requisi√ß√£o (Response), √© a resposta esperada (**BAD_REQUEST ü°™ 400**). Caso o HTTP Status da Resposta da Requisi√ß√£o seja 400, o **Teste Passa**. Caso seja outro Status, o **Teste Falha**.

Como o teste tem por objetivo checar se est√° duplicando usu√°rios no Banco de dados, ao inv√©s de checarmos se o objeto foi persistido (**CREATE ü°™ 201**), checaremos se ele n√£o foi persistido (**BAD_REQUEST ü°™ 400**). 

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/fundamentals/testing" target="_blank"><b>Documenta√ß√£o:  NestJS Testing</b></a></div>

<div align="left"><img src="https://i.imgur.com/3tsv1lE.png" title="source: imgur.com" width="30px"/> <a href="https://jestjs.io/pt-BR/docs/api" target="_blank"><b>Documenta√ß√£o: Jest</b></a></div>

<div align="left"><img src="https://i.imgur.com/kuK7aM3.png" title="source: imgur.com" width="35px"/> <a href="https://github.com/visionmedia/supertest#readme" target="_blank"><b>Documenta√ß√£o: Supertest</b></a></div>

<br />

<h3>M√©todo 03 - Deve autenticar um Usu√°rio (Login)</h3>



<div align="center"><img src="https://i.imgur.com/USkxUqJ.png" title="source: imgur.com" /></div>

**Linha 63:** Definimos o Teste **Deve Autenticar o Usu√°rio (Login)**, que foi criado atrav√©s do M√©todo **it()**, que indica que este M√©todo executar√° um teste.

**Linha 64:** Foi criada uma  **const**, chamada **resposta**, que receber√° a excu√ß√£o do M√©todo **request()**, que cria uma Requisi√ß√£o que ser√° enviada para a aplica√ß√£o que foi gerada pelo Nest com o ambiente de testes.

**Linha 65:** Define que a Requisi√ß√£o ser√° do tipo **POST**, atrav√©s do M√©todo **post()**,  e enviar√° a Requisi√ß√£o para o endere√ßo do endpoint Cadastrar Usuario (**/auth/logar**).

**Linhas 66 a 69:** Define os dados do Objeto **UsuarioLogin** que ser√£o enviados no Corpo da Requisi√ß√£o, atrav√©s do M√©todo **send()**. Nesta etapa, o processo √© equivalente ao que o Insomnia faz em uma requisi√ß√£o do tipo **POST**: Transforma os atributos num objeto da Classe UsuarioLogin, que ser√° enviado no corpo da requisi√ß√£o (Request Body).

**Linha 70:** Atrav√©s do m√©todo <b>expect()</b>, da Biblioteca SuperTest, checaremos se a Resposta HTTP da Requisi√ß√£o (Response), √© a resposta esperada (**OK ü°™ 200**). Caso o HTTP Status da Resposta da Requisi√ß√£o seja 200, o **Teste Passa**. Caso seja outro Status, o **Teste Falha**.

**Linha 72:** Vamos armazenar na vari√°vel **token** o Atributo **token** do usu√°rio autenticado, porqu√™ iremos utilizar o token em outros testes. Para obter o token, vamos utilizar o M√©todo **resposta.body.token**, para extrair o Atributo token do Corpo da Resposta da Requisi√ß√£o.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/fundamentals/testing" target="_blank"><b>Documenta√ß√£o:  NestJS Testing</b></a></div>

<div align="left"><img src="https://i.imgur.com/3tsv1lE.png" title="source: imgur.com" width="30px"/> <a href="https://jestjs.io/pt-BR/docs/api" target="_blank"><b>Documenta√ß√£o: Jest</b></a></div>

<div align="left"><img src="https://i.imgur.com/kuK7aM3.png" title="source: imgur.com" width="35px"/> <a href="https://github.com/visionmedia/supertest#readme" target="_blank"><b>Documenta√ß√£o: Supertest</b></a></div>

<br />


<h3>M√©todo 04 - Listar todos os Usu√°rios</h3>



<div align="center"><img src="https://i.imgur.com/t3RCDoX.png" title="source: imgur.com" /></div>

**Linha 76:** Definimos o Teste **Deve Listar todos os Usuarios**, que foi criado com o M√©todo **it()**, que indica que este M√©todo executar√° um teste.

**Linha 77:** Neste M√©todo, como n√£o iremos extrair nenhum atributo do Corpo da Requisi√ß√£o, n√£o foi criado uma **const**. Utilizamos a palavra **return** que executar√° e retornar√° a Resposta do M√©todo **request()**, que cria uma Requisi√ß√£o que ser√° enviada para a aplica√ß√£o que foi gerada pelo Nest com o ambiente de testes.

**Linha 78:** Define que a Requisi√ß√£o ser√° do tipo **GET**, atrav√©s do M√©todo **get()**, e enviar√° a Requisi√ß√£o para o endere√ßo do endpoint Listar todos os Usuarios (**/usuarios/all**).

**Linha 79:** Como o endpoint (**/usuarios/all**) est√° protegido pelo **Token JWT**, precisamos enviar o token de um usu√°rio v√°lido no cabe√ßalho da Requisi√ß√£o, atrav√©s do M√©todo **set()**. Como guardamos o token do usu√°rio Root (criado no primeiro teste e autenticado no segundo teste), na vari√°vel **token**, vamos enviar esta vari√°vel no par√¢metro **Authorization** do Cabe√ßalho (Header) da Requisi√ß√£o.

<br />

| <img src="https://i.imgur.com/nSpXEZ0.png" title="source: imgur.com" width="100px"/> | <p align="justify"> Observe que a var√°vel token foi passada entre acentos grave (o acento da crase) e n√£o entre aspas simples, definindo uma interpola√ß√£o de strings. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linha 81:** Atrav√©s do m√©todo <b>expect()</b>, da Biblioteca SuperTest, checaremos se a Resposta HTTP da Requisi√ß√£o (Response), √© a resposta esperada (**OK ü°™ 200**). Caso o HTTP Status Code da Resposta da Requisi√ß√£o seja 200, o **Teste Passa**. Caso seja outro Status, o **Teste Falha**.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/fundamentals/testing" target="_blank"><b>Documenta√ß√£o:  NestJS Testing</b></a></div>

<div align="left"><img src="https://i.imgur.com/3tsv1lE.png" title="source: imgur.com" width="30px"/> <a href="https://jestjs.io/pt-BR/docs/api" target="_blank"><b>Documenta√ß√£o: Jest</b></a></div>

<div align="left"><img src="https://i.imgur.com/kuK7aM3.png" title="source: imgur.com" width="35px"/> <a href="https://github.com/visionmedia/supertest#readme" target="_blank"><b>Documenta√ß√£o: Supertest</b></a></div>

<br />

<h3>M√©todo 05 - Deve atualizar um Usu√°rio</h3>



<div align="center"><img src="https://i.imgur.com/ljeXlow.png" title="source: imgur.com" /></div>

**Linha 83:** Definimos o Teste **Deve Atualizar Um Usuario**, que foi criado com o M√©todo **it()**, que indica que este M√©todo executar√° um teste.

**Linha 84:** Neste M√©todo, como n√£o iremos extrair nenhum atributo do Corpo da Requisi√ß√£o, n√£o foi criado uma **const**. Utilizamos a palavra **return** que executar√° e retornar√° a Resposta do M√©todo **request()**, que cria uma Requisi√ß√£o que ser√° enviada para a aplica√ß√£o que foi gerada pelo Nest com o ambiente de testes.

**Linha 85:** Define que a Requisi√ß√£o ser√° do tipo **PUT**, atrav√©s do M√©todo **put()**, e enviar√° a Requisi√ß√£o para o endere√ßo do endpoint Atualizar Usuario (**/usuarios/atualizar**).

**Linha 86:** Como o endpoint (**/usuarios/atualizar**) est√° protegido pelo **Token JWT**, precisamos enviar o token de um usu√°rio v√°lido no cabe√ßalho da Requisi√ß√£o, atrav√©s do M√©todo **set()**. Como guardamos o token do usu√°rio Root (criado no primeiro teste e autenticado no segundo teste), na vari√°vel **token**, vamos enviar esta vari√°vel no par√¢metro **Authorization** do Cabe√ßalho (Header) da Requisi√ß√£o.

<br />

| <img src="https://i.imgur.com/nSpXEZ0.png" title="source: imgur.com" width="100px"/> | <p align="justify"> Observe que a var√°vel token foi passada entre acentos grave (o acento da crase) e n√£o entre aspas simples, definindo uma interpola√ß√£o de strings. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linhas 87 a 93:** Define os dados do Objeto Usuario que ser√£o enviados no Corpo da Requisi√ß√£o, atrav√©s do M√©todo **send()**. Nesta etapa, o processo √© equivalente ao que o Insomnia faz em uma requisi√ß√£o do tipo **PUT**: Transforma os atributos num objeto da Classe Usuario, que ser√° enviado no corpo da requisi√ß√£o (Request Body).

Observe que como se trata de uma atualiza√ß√£o dos dados do usu√°rio Root, enviaremos o Atributo **id** para identificar o Objeto Usuario que desejamos atualizar. O id est√° sendo enviado atrav√©s da vari√°vel **usuarioId** (Linha 88), que recebeu o id do usu√°rio Root no primeiro teste.

**Linha 94:** Atrav√©s do m√©todo <b>expect()</b>, da Biblioteca SuperTest, checaremos se a Resposta HTTP da Requisi√ß√£o (Response), √© a resposta esperada (**OK ü°™ 200**). Caso o HTTP Status da Resposta da Requisi√ß√£o seja 200, o **Teste Passa**. Caso seja outro  Status, o **Teste Falha**.

**Linhas 95 a 97:** Atrav√©s do m√©todo <b>then()</b>, da Biblioteca SuperTest, vamos acessar e verificar se a altera√ß√£o foi realmente efetuada, comparando o Atributo nome, que foi recebido no Corpo da Resposta com a altera√ß√£o que foi enviada na Requisi√ß√£o. Observe que a Resposta da Requisi√ß√£o ser√° armazenada no Objeto **resposta**, criado na Arrow Function, dentro do M√©todo then().

**Linha 96:** Atrav√©s do m√©todo de asser√ß√£o <b>expect().toEqual()</b>, do Framework Jest, checaremos se o Atributo nome enviado na Requisi√ß√£o foi persistido corretamente no Banco de Dados. Para obter o Atributo nome, recebido no Corpo da Requisi√ß√£o, utilizaremos a instru√ß√£o **resposta.body.token**. Na sequ√™ncia faremos a compara√ß√£o com o conte√∫do que foi enviado no Atributo nome (Root Atualizado) no Corpo da Requisi√ß√£o, atrav√©s da instru√ß√£o abaixo:

<br />

```ts
expect( **Conte√∫do Enviado** ).toEqual( **Conte√∫do Recebido** )
```

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <p align="justify"> **ATEN√á√ÉO:** *Para que o teste **Deve Atualizar Um Usuario()** seja aprovado, os 2 testes (linhas 94 e 96) devem ser aprovados, caso contr√°rio o Jest indicar√° que o teste Falhou!.* </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />


| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao escrever os testes da aplica√ß√£o. N√£o confunda o M√©todo expect() do Framework Jest com o M√©todo expect() da Biblioteca SuperTest. Embora a escrita seja a mesma, os M√©todos possuem fun√ß√µes diferentes.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/fundamentals/testing" target="_blank"><b>Documenta√ß√£o:  NestJS Testing</b></a></div>

<div align="left"><img src="https://i.imgur.com/3tsv1lE.png" title="source: imgur.com" width="30px"/> <a href="https://jestjs.io/pt-BR/docs/api" target="_blank"><b>Documenta√ß√£o: Jest</b></a></div>

<div align="left"><img src="https://i.imgur.com/3tsv1lE.png" title="source: imgur.com" width="30px"/> <a href="https://jestjs.io/pt-BR/docs/expect" target="_blank"><b>Documenta√ß√£o: M√©todo Expect - Jest</b></a></div>

<div align="left"><img src="https://i.imgur.com/kuK7aM3.png" title="source: imgur.com" width="35px"/> <a href="https://github.com/visionmedia/supertest#readme" target="_blank"><b>Documenta√ß√£o: Supertest</b></a></div>

<br />

Abaixo voc√™ confere a vers√£o final da Classe de testes:

<br />

```ts
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from '../src/app.module';
import { TypeOrmModule } from '@nestjs/typeorm';

describe('Testes dos M√≥dulos Usuario e Auth (e2e)', () => {

  let token: any;
  let usuarioId: any;
  let app: INestApplication;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [
        TypeOrmModule.forRoot({
          type: 'sqlite',
          database: ':memory:',
          entities: [__dirname + "./../src/**/entities/*.entity.ts"],
          synchronize: true,
          dropSchema: true,
        }),
        AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    app.useGlobalPipes(new ValidationPipe());
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  })

  it("01 - Deve Cadastrar um novo Usu√°rio", async () => {
    const resposta = await request(app.getHttpServer())
      .post('/usuarios/cadastrar')
      .send({
        nome: 'Root',
        usuario: 'root@root.com',
        senha: 'rootroot',
        foto: '-',
      })
      .expect(201)

    usuarioId = resposta.body.id;

  });

  it("02 - N√£o Deve Cadastrar um Usu√°rio Duplicado", async () => {
    await request(app.getHttpServer())
      .post('/usuarios/cadastrar')
      .send({
        nome: 'Root',
        usuario: 'root@root.com',
        senha: 'rootroot',
        foto: '-',
      })
      .expect(400)

  });

  it("03 - Deve Autenticar o Usu√°rio (Login)", async () => {
    const resposta = await request(app.getHttpServer())
    .post("/usuarios/logar")
    .send({
      usuario: 'root@root.com',
      senha: 'rootroot',
    })
    .expect(200)

    token = resposta.body.token;

  })

  it("04 - Deve Listar todos os Usu√°rios", async () => {
    return request(app.getHttpServer())
    .get('/usuarios/all')
    .set('Authorization', `${token}`)
    .send({})
    .expect(200)
  })

  it("05 - Deve Atualizar um Usu√°rio", async () => {
    return request(app.getHttpServer())
    .put('/usuarios/atualizar')
    .set('Authorization', `${token}`)
    .send({
      id: usuarioId,
      nome: 'Root Atualizado',
      usuario: 'root@root.com',
      senha: 'rootroot',
      foto: '-',
    })
    .expect(200)
    .then( resposta => {
      expect("Root Atualizado").toEqual(resposta.body.nome);
    })

  })

});
```

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/conteudoGeneration/backend_blogpessoal_nest/blob/14_Testes_com_Jest/blogpessoal/test/usuario.e2e-spec.ts" target="_blank"><b>C√≥digo fonte: app.e2e-spec.ts</b></a> 
</div>

<br />

<h2>üë£ Passo 02 - Executar os Testes no VSCode</h2>



1. Abra o Tewrminal.
1. Digite o comando ***npm run test:e2e***, para compilar e executar os testes do Projeto **blogpessoal**. 

```bash
npm run test:e2e
```

3. Se tudo deu certo, o resultado ser√° semelhante ao da figura abaixo:

<div align="center"><img src="https://i.imgur.com/1ZN6Iy4.png?1" title="source: imgur.com" /></div>

4. Observe na imagem acima que todos os testes foram aprovados.

<br />

> [!TIP]
>
> Caso voc√™ tenha mais de uma Classe de Teste, todas as Classes ser√£o executadas de uma √∫nica vez. Para rodar apenas uma Classe de Teste espec√≠fica, utilize o comando abaixo:
>
> ```bash
> npm run test:e2e nome_da_classe_teste
> ```
>
> **Onde:**
>
> **nome_da_classe_teste** √© o nome da Classe de Teste que voc√™ deseja executar.

<br />

| <img src="https://i.imgur.com/L338M2G.png" title="source: imgur.com" width="100px"/> | DESAFIO: Fa√ßa algumas altera√ß√µes nos dados dos Objetos e/ou escreva outros testes para praticar. A melhor forma de aprender e compreender como funcionam os testes √© praticando! |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/conteudoGeneration/backend_blogpessoal_nest/tree/14_Testes_com_Jest" target="_blank"><b>C√≥digo fonte do projeto</b></a></div>

<br />

<h2>‚úî Boas pr√°ticas</h2>

1. **Fa√ßa testes pequenos.**
2. **Fa√ßa testes r√°pidos:** Os testes devem ser simples e objetivos porqu√™ ser√£o executados o tempo todo.
3. **Fa√ßa testes determin√≠sticos:** O teste deve garantir o resultado.
4. **Utilize nomes auto descritivos:** A ideia √© que voc√™ entenda o que o teste faz sem precisar abri-lo.
6. **Insira poucas asser√ß√µes em cada teste:** O objetivo √© que um teste seja respons√°vel por apenas uma verifica√ß√£o.
7. **Sempre avalie os resultados dos seus testes.**

<br /> <br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
