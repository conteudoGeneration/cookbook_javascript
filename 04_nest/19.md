<h1>Projeto 02 - Blog Pessoal - M√≥dulo Auth - Parte 02</h1>

<br />

O que veremos por aqui:

1. Instala√ß√£o do Passport Local, Passport JWT e @nestjs/jwt.
2. Criar a Classe LocalAuthGuard.
3. Criar a Classe LocalStrategy.
4. Criar a Classe Constant.
5. Criar a Classe AuthService.
6. Registrar as Classes LocalStrategy e AuthService na Classe AuthModule.
7. Importar os M√≥dulos UsuarioModule, PassportModule e JwtModule.

<br />

<h2>1. O M√≥dulo Auth</h2>



Nesta etapa vamos implementar a seguran√ßa da aplica√ß√£o atrav√©s da Biblioteca Passport. Iremos implementar 2 estrat√©gias do Passport:

1. **Local:** O processo de autentica√ß√£o do usu√°rio (login).
2. **JWT:** O processo de gera√ß√£o do Token de Autoriza√ß√£o no formato JWT (JSON WEB Token)

A implementa√ß√£o do Passport ser√° composta por 7 Classes:

| Classe / Arquivo   | Descri√ß√£o                                                    |
| ------------------ | ------------------------------------------------------------ |
| **LocalAuthGuard** | Classe respons√°vel por criar o **Local Guard**, que √© um Guard personalizado implementado por meio da heran√ßa da Classe **AuthGuard**. Ao extender a Classe **AuthGuard**, o **Passport** gera um Guard chamado **local**, que ser√° utilizado pelo endpoint de autentica√ß√£o para validar e processar as credenciais do usu√°rio (usu√°rio e senha). |
| **LocalStrategy**  | Classe respons√°vel por implementar a Local Strategy do Passport, ou seja, a autentica√ß√£o atrav√©s da credenciais, com valida√ß√£o via Banco de dados. |
| **Constants**      | Script que definir√° a chave secreta (Secret) de assinatura do Token JWT. |
| **AuthService**    | Classe Respons√°vel por criar os M√©todos de autentica√ß√£o e gera√ß√£o do Token JWT. |
| **JwtAuthGuard**   | Classe respons√°vel por criar o **JWT Guard**, que √© um Guard personalizado implementado por meio da heran√ßa da Classe **AuthGuard**. Ao extender a Classe **AuthGuard**, o **Passport** gera um Guard chamado **jwt**, que ser√° utilizado para proteger endpoints que exigem autentica√ß√£o. Esse Guard valida a presen√ßa do **Token JWT** gerado durante a autentica√ß√£o no cabe√ßalho das requisi√ß√µes HTTP enviadas pelo usu√°rio. |
| **JwtStrategy**    | Classe respons√°vel por implementar a JWT Strategy do Passport, ou seja, a valida√ß√£o do Token JWT, enviado no Cabe√ßalho das Requisi√ß√µes HTTP. |
| **AuthController** | Classe Respons√°vel por criar o endpoint de autentica√ß√£o (login). |

<br />

> **Guard:** t√™m uma responsabilidade clara no **NestJS**: determinar se uma requisi√ß√£o HTTP deve ser processada diretamente ou se precisa passar por uma valida√ß√£o, com base em condi√ß√µes espec√≠ficas (como permiss√µes, fun√ß√µes de usu√°rio, entre outros) verificadas em tempo de execu√ß√£o.
>
> Embora frequentemente associados √† **autoriza√ß√£o**, os Guards, na pr√°tica, direcionam a requisi√ß√£o HTTP para um validador configurado no m√©todo da classe controladora, utilizando o decorador **@UseGuards**.
>
> Se o m√©todo n√£o estiver decorado com **@UseGuards**, ele ser√° acessado livremente, sem passar por qualquer valida√ß√£o ou restri√ß√£o.

<br />

Na parte 02, vamos implementar as 4 primeiras Classes e na parte 03 implementaremos as 3 ultimas Classes e faremos todos os testes no Insomnia.

<br />

<h2>üë£ Passo 01- Instala√ß√£o dos Pacotes das Bibliotecas Passport e Nestjs JWT</h2>



Vamos instalar os Pacotes do Passport atrav√©s do NPM:

1. Abra o **Terminal** do VSCode atrav√©s do menu **Terminal ü°™ New Terminal**
2. Para instalar o pacote **Passport-Local**, digite o comando abaixo:

```bash
npm install --save @nestjs/passport passport passport-local
```

3. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/myR8c8V.png?1" title="source: imgur.com" /></div>

4. Para instalar o pacote **Types-Passport-Local**, digite o comando abaixo:

```bash
npm install --save-dev @types/passport-local
```

5. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/L0XxXr9.png?1" title="source: imgur.com" /></div>

6. Para instalar os pacotes **Passport-Jwt** e **Nestjs-jwt**, digite o comando abaixo:

```bash
npm install --save @nestjs/jwt passport-jwt
```

7. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/TZNPQ0Q.png?1" title="source: imgur.com" /></div>

8. Para instalar o pacote **Types-Passport-Jwt**, digite o comando abaixo:

```bash
npm install --save-dev @types/passport-jwt
```

9. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/7z5iTkE.png?1" title="source: imgur.com" /></div>
<br />

<h2>üë£ Passo 02 - Atualizar a estrutura de pastas do M√≥dulo Auth</h2>



Vamos criar algumas pastas no M√≥dulo Auth:

1. Na pasta **auth**, clique com o bot√£o direito do mouse e clique na op√ß√£o **New Folder** (Nova Pasta). 

2. Crie a pasta **constants**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 

3. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 

4. Crie a pasta  **controllers**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 

5. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 

6. Crie a pasta  **guard**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 
7. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 
8. Crie a pasta  **services**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 
9. Clique com o bot√£o direito do mouse sobre a pasta **auth** e clique na op√ß√£o **New Folder** (Nova Pasta). 
10. Crie a pasta  **strategy**. Ap√≥s digitar o nome da pasta, pressione a tecla **enter** do seu teclado para concluir. 
11. A estrutura de pastas do **M√≥dulo Auth**, ficar√° igual a imagem abaixo:


<div align="center"><img src="https://i.imgur.com/Asiq9z2.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="90px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar as novas pastas dentro do M√≥dulo Auth. Um erro muito comum √© criar as pastas fora da pasta do m√≥dulo (auth).* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 03 - Criar a Classe LocalAuthGuard</h2>



Neste passo, vamos criar a Classe **LocalAuthGuard**, que chamaremos de **local-auth.guard.ts**. Nesta Classe vamos criar o **Guard** personalizado, que ser√° utilizado pelo endpoint de autentica√ß√£o para receber as credenciais do usu√°rio (usuario e senha) e enviar para o Passport Local Strategy validar e autenticar o usu√°rio no sistema. 

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe LocalAuthGUard. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

1. Clique com o bot√£o direito do mouse sobre a **pasta guard**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**local-auth.guard.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/BKdtpvo.png" title="source: imgur.com" /></div>

Agora vamos implementar o c√≥digo da Classe **LocalAuthGuard**:

```typescript
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class LocalAuthGuard extends AuthGuard('local') {}
```

Observe que a Classe de Servi√ßo **LocalAuthGuard** foi criada como uma Heran√ßa da Classe **AuthGuard**, que pertence ao **Passport Strategy local**.

Essa Classe ser√° utilizada na Classe **AuthController**, no M√©todo **login**, para redirecionar as Requisi√ß√µes de Login para a **Estrat√©gia Local do Passport**, ou seja, a autentica√ß√£o do usu√°rio, via Banco de dados.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/guards" target="_blank"><b>Documenta√ß√£o: NestJS Guards</b></a></div>

<div align="left"><img src="https://i.imgur.com/51OZ5ug.png" title="source: imgur.com" width="30px"/> <a href="https://www.passportjs.org/packages/passport-local/" target="_blank"><b>Documenta√ß√£o: Passport Local Strategy</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/guard/local-auth.guard.ts" target="_blank"><b>C√≥digo fonte da Classe LocalAuthGuard</b></a>
<br /></div>

<br />

<h2>üë£ Passo 04 - Criar a Classe LocalStrategy</h2>



Neste passo, vamos criar a Classe **LocalStrategy**, que chamaremos de **local.strategy.ts**. Nesta Classe vamos implementar o **Local Strategy do Passport**, que ser√° utilizado no processo de autentica√ß√£o para validar as credenciais do usu√°rio (usuario e senha). 

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe LocalStrategy. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

1. Clique com o bot√£o direito do mouse sobre a **pasta strategy**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**local.strategy.ts**) e pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/U6a7YeS.png" title="source: imgur.com" /></div>

Agora vamos implementar o c√≥digo da Classe **LocalStrategy**:

```typescript
import { Injectable, UnauthorizedException } from "@nestjs/common";
import { PassportStrategy } from "@nestjs/passport";
import { Strategy } from "passport-local";
import { AuthService } from "../services/auth.service";

@Injectable()
export class LocalStrategy extends PassportStrategy(Strategy) {

    private _usernameField: string;
    private _passwordField: string;

    constructor(private readonly authService: AuthService) {
        super(); 
        this._usernameField = 'usuario';
        this._passwordField = 'senha';
    }

    async validate(usuario: string, senha: string): Promise<any> {
        const validaUsuario = await this.authService.validateUser(usuario, senha);
        if (!validaUsuario) {
            throw new UnauthorizedException("Usu√°rio e/ou senha incorretos!");
        }
        return validaUsuario;
    }

}

```

Vamos analisar o c√≥digo:

<div align="center"><img src="https://i.imgur.com/Xfxcu6B.png" title="source: imgur.com" /></div>

**Linha 3:** Ao importar a Classe Strategy, verifique se ela foi importada corretamente da Biblioteca **passport-local**. A Biblioteca **passport-jwt** tamb√©m cont√©m uma Classe chamada **Strategy** e √© muito comum confundir na hora da importa√ß√£o.

**Linha 7:** Criamos a Classe de Servi√ßo LocalStrategy, que estende a Classe PassportStrategy. A Classe PassportStrategy requer como par√¢metro a **Strategy**, que √© fornecida pela biblioteca **passport-local** (importada na linha 3) e implementa a Local Strategy do Passport.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="80px"/> | <div align="left"> **ATEN√á√ÉO:** *Tanto o pacote passport-local quanto passport-jwt possuem a Classe Strategy. Observe que na Linha 03 foi importada a Classe Strategy do pacote passport-local.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linhas 8 a 9:** Criamos os atributos privados **_usernameField** e **_passwordField**, que permitem personalizar os nomes dos atributos de autentica√ß√£o esperados pelo Passport. Os atributos esperados por padr√£o s√£o **username** e **password**.

**Linha 12:** Criamos o M√©todo Construtor, que recebe as Inje√ß√µes de Depend√™ncia necess√°rias. Como precisaremos acessar os m√©todos da **Classe AuthService**, injetamos um Objeto dessa Classe no Construtor da **LocalStrategy**.

**Linha 13:** No Construtor da Classe **LocalStrategy**, chamamos o m√©todo **super()** sem par√¢metros. Esse m√©todo inicializa a **PassportStrategy**, estabelecendo a base para a nossa estrat√©gia local.

**Linhas 14 e 15:** A estrat√©gia local do Passport, por padr√£o, espera que os atributos de autentica√ß√£o enviados no corpo da requisi√ß√£o estejam em um objeto JSON, nomeados como **username** e **password**. No entanto, nossa classe auxiliar  **UsuarioLogin** foi definida com os atributos **usuario** e **senha**. Para resolver essa diferen√ßa e garantir que o Passport utilize os atributos corretos, adicionamos os atributos **_usernameField** e **_passwordField** na classe **LocalStrategy** e na sequ√™ncia, dentro do m√©todo construtor, substitu√≠mos os atributos padr√£o pelos atributos **usuario** e **senha**.

<div align="center"><img src="https://i.imgur.com/399BiJK.png" title="source: imgur.com" /></div>

**Linha 18:** Criamos o M√©todo Ass√≠ncrono (async) **validate(usuario: string, senha: string)**, que retorna uma **Promise** contendo um **Objeto** do tipo **any**.

Observe que o M√©todo **validate** recebe dois par√¢metros do tipo **string**: **usuario** e **senha**, que s√£o fornecidos durante o processo de autentica√ß√£o (login) do usu√°rio.

**Linha 20:** Dentro do m√©todo **validate**, chamamos o M√©todo **validateUser(usuario, senha)** da Classe **AuthService**. Esse m√©todo valida se o usu√°rio existe e se a senha fornecida est√° correta. Se ambos forem validados, o m√©todo retorna um **Objeto da Classe Usuario**, sem o atributo **senha** (para garantir seguran√ßa e boas pr√°ticas). Esse objeto representa o usu√°rio autenticado.

**Linha 22:** Verificamos se o Objeto **validaUsuario** n√£o foi encontrado. Caso o usu√°rio tenha fornecido um e-mail ou uma senha incorreta, o Objeto **validaUsuario** retornar√° o valor **nulo** e uma exce√ß√£o ser√° lan√ßada.

**Linha 23:** Se o Objeto **validaUsuario** for **nulo**, ou seja, se o usu√°rio n√£o for autenticado, ser√° retornado o HTTP Status **UNAUTHORIZED ü°™ 401** com a mensagem **"Usu√°rio e/ou Senha incorretos!"**.

**Linha 25:** Se o Objeto **validaUsuario** for encontrado, ou seja, se a autentica√ß√£o for bem-sucedida, o m√©todo retorna o objeto **validaUsuario** para a Classe que chamou o m√©todo, contendo os dados do usu√°rio autenticado.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/51OZ5ug.png" title="source: imgur.com" width="30px"/> <a href="https://www.passportjs.org/packages/passport-local/" target="_blank"><b>Documenta√ß√£o: Passport Local Strategy</b></a></div>

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="30px"/> <a href="https://www.typescriptlang.org/docs/handbook/2/classes.html" target="_blank"><b>Documenta√ß√£o: Classes e M√©todos</b></a></div>

<div align="left"><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="30px"/> <a href="https://www.typescriptlang.org/docs/handbook/variable-declarations.html#let-vs-const" target="_blank"><b>Documenta√ß√£o: Decalara√ß√£o de variaveis</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/strategy/local.strategy.ts" target="_blank"><b>C√≥digo fonte da Classe LocalStrategy</b></a>
<br /></div>
<br />

<h2>üë£ Passo 05 - Criar o Script Constants</h2>



Neste passo, criaremos a constante **jwtConstants** no arquivo **constant.ts**, que ser√° respons√°vel por armazenar a **chave de assinatura do Token JWT (Secret)**. Todos os Tokens JWT gerados na aplica√ß√£o ser√£o assinados utilizando essa chave. √â importante enfatizar que, em uma aplica√ß√£o em produ√ß√£o, quanto mais complexa for a chave, maior ser√° a seguran√ßa dos Tokens JWT. Al√©m disso, ao receber uma requisi√ß√£o com um Token JWT, a aplica√ß√£o validar√° o token utilizando essa mesma chave de assinatura.

Outro ponto importante √© que, nesta implementa√ß√£o do Passport Local, estamos armazenando a **secret** diretamente no arquivo **constant.ts** para simplificar a implementa√ß√£o e facilitar a compreens√£o. No entanto, em um ambiente de produ√ß√£o, a **secret** deve ser configurada como uma vari√°vel de ambiente, pois ela n√£o pode ficar exposta no c√≥digo-fonte, garantindo maior seguran√ßa e prote√ß√£o contra acessos indevidos.

1. Clique com o bot√£o direito do mouse sobre a **pasta constants**, que foi criada dentro da pasta **auth**, e clique na op√ß√£o **New File** (Novo Arquivo).
2. Digite o nome do arquivo (**constants.ts**) e  pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/I8yfHtm.png" title="source: imgur.com" /></div>

Agora vamos implementar o c√≥digo do arquivo **constants.ts**:

```typescript
export const jwtConstants = {
    secret: '37eb3d74e44561d2b9ec3e40da179f9e91571b7f350aee31cfee06b481f146fe',
};
```

Observe que a **const jwtConstants** foi criada dentro do arquivo **constants.ts**. A **const jwtConstants** possui a propriedade **secret**, que armazenar√° a **chave de assinatura do Token JWT**. 

O valor atribu√≠do ao atributo **secret** √© uma chave encriptada aleat√≥ria, gerada atrav√©s do algoritmo de Criptografia chamado **AES**. 

> O **Advanced Encryption Standard (AES)** √© uma especifica√ß√£o de criptografia de dados eletr√¥nicos estabelecida pelo Instituto Nacional de Padr√µes e Tecnologia (NIST) dos Estados Unidos em 2001. O AES √© amplamente utilizado atualmente devido √† sua capacidade de gerar chaves extremamente seguras, tornando-as muito dif√≠ceis de serem quebradas, mesmo com os m√©todos mais avan√ßados de ataque dispon√≠veis.

Para gerar esta chave, utilizamos o site **Key Generator** (<a href="https://generate-random.org/encryption-key-generator" target="_blank"><b>https://generate-random.org/encryption-key-generator</b></a>), que permite gerar chaves encriptadas aleat√≥rias no formato **SHA 256**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/alJdfIG.png" title="source: imgur.com" /></div>

Copie a Chave hexadecimal gerada automaticamente pelo site clicando no bot√£o **Click to copy** e na sequ√™ncia cole a chave (CTRL + V) no atributo **secret**.

> **Hexadecimal √© o sistema num√©rico de base 16, que utiliza os s√≠mbolos 0‚Äì9 e A‚ÄìF para representar os seus elementos**.
>
> **Exemplo:**
>
> O n√∫mero decimal 79, representado pelo Sistema Bin√°rio √©  **01001111** 
>
> No **Sistema Hexadecimal** ele pode ser escrito como **4F** 
>
> ***4** = 0100*
>
> ***F** = 1111*
>
> Cada d√≠gito Hexadecimal consegue representar 4 bits do Sistema Bin√°rio.

A **secret** ser√° utilizada na classe **JwtStrategy** para validar o Token enviado no cabe√ßalho das requisi√ß√µes direcionadas aos endpoints protegidos da aplica√ß√£o. Al√©m disso, a secret tamb√©m ser√° usada para assinar os Tokens JWT gerados pelo m√©todo **sign()** da **classe JwtService**, que ser√° injetada na **classe AuthService** para **criar o Token JWT** ap√≥s a autentica√ß√£o (login) do usu√°rio. A **classe JwtService** faz parte do m√≥dulo **JwtModule** do **NestJS** e ser√° registrada na **classe AuthModule** nos pr√≥ximos passos.

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ATEN√á√ÉO:** *N√£o devemos expor a secret publicamente. Em um aplicativo em produ√ß√£o, essa chave deve ser protegida usando mecanismos, como vari√°veis de ambiente, cofre secreto ou servi√ßos de configura√ß√£o com base no controle de acesso adequado.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/RlHVydi.png" title="source: imgur.com" width="25px"/> <a href="https://generate-random.org/encryption-key-generator" target="_blank"><b>Ferramenta: Key Generator</b></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://docs.nestjs.com/security/authentication" target="_blank"><b>Documenta√ß√£o: NestJS Authentication</b></a></div>

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/nestjs/jwt" target="_blank"><b>Documenta√ß√£o: NestJS JwtModule</b></a></div>

<div align="left"><img src="https://i.imgur.com/WeNdbPo.png" title="source: imgur.com" width="35px"/> <a href="https://jwt.io/introduction" target="_blank"><b>Documenta√ß√£o: JWT - JSON WEB Token</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/constants/constants.ts" target="_blank"><b>C√≥digo fonte do arquivo constants.ts</b></a>
<br /></div>
<br />

<h2>üë£ Passo 06 - Criar a Classe AuthService</h2>



A Classe **AuthService** ser√° respons√°vel por criar os M√©todos de Autentica√ß√£o (login) e Validate (validar as credenciais do  usuario e gerar o token JWT). 

<br />


| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe AuthService. N√≥s iremos criar esta Classe AuthService antes das Classes valida√ß√£o do Token JWT para evitar alguns erros no Passport Local Strategy.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />


1. Clique com o bot√£o direito do mouse sobre a **pasta services**, que foi criada dentro da pasta **auth** e na sequ√™ncia clique na op√ß√£o **New File** (Novo Arquivo).

2. Digite o nome do arquivo (**auth.service.ts**) pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/cEIui2J.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar Classe de Servi√ßo. Um erro muito comum √© digitar o nome da Classe de forma incorreta. O nome da Classe deve estar dentro dos padr√µes do Nest (nome_do_modulo.tipo_da_classe.ts) para evitar erros na sua aplica√ß√£o.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

Veja abaixo a implementa√ß√£o da Classe **AuthService**:

```typescript
import { JwtService } from '@nestjs/jwt';
import { UsuarioService } from './../../usuario/services/usuario.service';
import { HttpException, HttpStatus, Injectable } from "@nestjs/common";
import { Bcrypt } from '../bcrypt/bcrypt';
import { UsuarioLogin } from '../entities/usuariologin.entity';


@Injectable()
export class AuthService{
    constructor(
        private usuarioService: UsuarioService,
        private jwtService: JwtService,
        private bcrypt: Bcrypt
    ){ }

    async validateUser(username: string, password: string): Promise<any>{

        const buscaUsuario = await this.usuarioService.findByUsuario(username)

        if(!buscaUsuario)
            throw new HttpException('Usu√°rio n√£o encontrado!', HttpStatus.NOT_FOUND)

        const matchPassword = await this.bcrypt.compararSenhas(password, buscaUsuario.senha)

        if(buscaUsuario && matchPassword){
            const { senha, ...resposta } = buscaUsuario
            return resposta
        }

        return null

    }

    async login(usuarioLogin: UsuarioLogin){

        const payload = { sub: usuarioLogin.usuario }

        const buscaUsuario = await this.usuarioService.findByUsuario(usuarioLogin.usuario)

        return{
            id: buscaUsuario.id,
            nome: buscaUsuario.nome,
            usuario: usuarioLogin.usuario,
            senha: '',
            foto: buscaUsuario.foto,
            token: `Bearer ${this.jwtService.sign(payload)}`,
        }

    }
}
```

Vamos analisar a implementa√ß√£o do c√≥digo, com foco nas diferen√ßas em rela√ß√£o aos M√≥dulos anteriores:

<br />

<h3> 6.1 M√©todo Constructor()</h3>



O M√©todo **Constructor()** recebe as **Inje√ß√µes de Depend√™ncia** necess√°rias para o desenvolvimento da Classe de Servi√ßo.

<div align="center"><img src="https://i.imgur.com/LTcg323.png" title="source: imgur.com" /></div>

- **Linha 10:** Al√©m da inje√ß√£o de depend√™ncia da **classe de servi√ßo UsuarioService**, o m√©todo receber√° outras duas inje√ß√µes de depend√™ncia:
  - **Classe JwtService**: Servi√ßo respons√°vel pela gera√ß√£o do Token JWT.
  - **Classe Bcrypt**: Servi√ßo do m√≥dulo **Auth** respons√°vel por verificar se o **atributo senha do objeto da classe UsuarioLogin** (senha n√£o criptografada) corresponde ao **atributo senha do objeto da classe Usuario** (senha criptografada) armazenado no banco de dados.

<br />

<h3>6.2 M√©todo validateUser(usuario: string, senha: string)</h3>



O M√©todo **validateUser(usuario: string, senha: string)** ser√° respons√°vel por **validar os Atributos usuario (e-mail) e a senha** enviados no Objeto UsuarioLogin. Caso os dados dos 2 Atributos sejam validados, o usu√°rio ser√° autenticado.

<div align="center"><img src="https://i.imgur.com/xoqV3j5.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 16:** Criamos o m√©todo ass√≠ncrono (async) chamado **validateUser(usuario: string, senha: string)**, que retorna uma **Promise** contendo **apenas um** objeto do tipo **any**.

O m√©todo **validateUser(usuario: string, senha: string)** possui dois par√¢metros do tipo **string**, chamados **usuario** e **senha**, que s√£o recebidos durante o processo de autentica√ß√£o (login) do usu√°rio.

**Linha 18:** Criamos um objeto da classe **Usuario**, chamado **buscaUsuario**, que armazena o resultado da execu√ß√£o do m√©todo **findByUsuario(usuario: Usuario)** da classe **UsuarioService**. Esse m√©todo verifica se o usu√°rio existe no sistema.

**Linha 20:** Validamos se o objeto **buscaUsuario** √© nulo, ou seja, se o usu√°rio n√£o foi encontrado. Caso seja nulo, o m√©todo retorna o HTTP Status **NOT_FOUND ‚Üí 404** (N√£o Encontrado).

**Linha 23:** Criamos o objeto **validaSenha**, que armazena o resultado da execu√ß√£o do m√©todo **compararSenhas(senhaBanco: string, senhaDigitada: string)** da classe **Bcrypt**. Esse m√©todo verifica se a senha armazenada no banco de dados corresponde √† senha informada no objeto **UsuarioLogin**. O m√©todo retornar√° **true** (**Match**) se as senhas forem iguais.

Veja o exemplo nas imagens abaixo, da ferramenta **Bcrypt Generator**:

<table>
  <tr>
    <td width="50%"><img src="https://i.imgur.com/YCGbZwt.png" title="source: imgur.com" /></td>
    <td width="50%"><img src="https://i.imgur.com/EHEdZea.png" title="source: imgur.com" /></td>
  </tr>
</table>

<br />

A ferramenta on-line **Bcrypt Generator** simula o funcionamento do algoritmo hash Bcrypt. No exemplo, utilizamos a mesma senha criptografada nas duas imagens, mas alteramos a senha digitada. Na primeira imagem, ao inserir a senha correta, a ferramenta exibe **Match! (true)**. J√° na segunda imagem, ao inserir uma senha incorreta, a ferramenta exibe **Not a Match! (false)**. O m√©todo **compararSenhas(senhaBanco: string, senhaDigitada: string)** realiza a mesma fun√ß√£o: verifica se a senha n√£o criptografada corresponde √† senha criptografada armazenada, utilizando o Bcrypt.

**Linha 25:** Verifica se o **objeto buscaUsuario foi encontrado** e se o **objeto validaSenha √© igual a true**.

**Linha 26:** Nesta linha, foi utilizada uma combina√ß√£o de dois recursos do TypeScript: a **desestrutura√ß√£o** em conjunto com o **rest operator** (operador de resto), que √© uma funcionalidade do TypeScript, semelhante ao spread operator (`...`), mas com a diferen√ßa de que ele coleta o restante das propriedades em um objeto. Vamos analisar a linha por partes:

- **`{ senha, ...resposta }`**: A desestrutura√ß√£o extrai a propriedade `senha` do objeto `buscaUsuario` e armazena o restante das propriedades em um novo objeto chamado `resposta`.
- **`senha`**: Cont√©m apenas o valor da propriedade `senha` de `buscaUsuario`.
- **`...resposta`**: Coleta todos os demais atributos do objeto `buscaUsuario`, que n√£o foram explicitamente desestruturados (neste caso, todos os atributos, menos `senha`) e as coloca no objeto `resposta`.

> A **desestrutura√ß√£o** √© uma maneira de extrair m√∫ltiplos valores de arrays ou objetos e atribu√≠-los a vari√°veis de forma simples. Com a desestrutura√ß√£o de objetos, voc√™ pode extrair propriedades de um objeto diretamente para vari√°veis.
>
> **Exemplo:**
>
> ```typescript
> const pessoa = { nome: 'Sabrina Alves', idade: 30, cidade: 'S√£o Paulo' };
> 
> // Desestruturando o objeto
> const { nome, idade } = pessoa;
> 
> console.log(nome);  // 'Sabrina Alves'
> console.log(idade); // 30
> ```
>
> No exemplo acima, a vari√°vel `nome` recebe o valor `'Sabrina Alves'` e a vari√°vel `idade` recebe o valor `30` diretamente, sem precisar acessar as propriedades do objeto de forma tradicional (`pessoa.nome`, `pessoa.idade`).

<br />

> O **operador rest** √© representado por `...` e serve para coletar o restante das propriedades ou elementos que n√£o foram explicitamente desestruturados. Ele pode ser usado tanto em objetos quanto em arrays. Ao usar o operador rest, voc√™ pode extrair algumas propriedades de um objeto e pegar o restante delas em um novo objeto.
>
> **Exemplo:**  
>
> ```typescript
> const pessoa = { nome: 'Sabrina Alves', idade: 30, cidade: 'S√£o Paulo' };
> 
> // Desestruturando e usando o rest operator
> const { nome, ...resto } = pessoa;
> 
> console.log(nome);  // 'Sabrina Alves'
> console.log(resto); // { idade: 30, cidade: 'S√£o Paulo' }
> ```
>
> No exemplo acima, o operador rest (`...resto`) coleta todas as propriedades restantes do objeto, exceto `nome`, e as coloca em um novo objeto chamado `resto`.

**Linha 27:** Retorna apenas o **objeto ...resposta**, ou seja, um objeto contendo todos os atributos do usu√°rio, exceto a senha, seguindo as boas pr√°ticas de seguran√ßa.

**Linha 30:** Caso as duas condi√ß√µes sejam falsas, o m√©todo retornar√° **null**, e a aplica√ß√£o responder√° com o HTTP Status **UNAUTHORIZED ‚Üí 401** (Acesso n√£o autorizado).

<br />

<h3> 6.3 M√©todo login(usuarioLogin: UsuarioLogin)</h3>



O m√©todo **login(usuarioLogin: UsuarioLogin)** ser√° respons√°vel por receber as credenciais do usu√°rio e envi√°-las ao Passport para **autenticar (fazer login) e validar o usu√°rio na aplica√ß√£o**. Este m√©todo √© essencial para o funcionamento do **Passport**, pois, sem a autentica√ß√£o, n√£o ser√° poss√≠vel gerar o Token JWT nem obter acesso aos endpoints protegidos.

<div align="center"><img src="https://i.imgur.com/AFa5gjZ.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo do M√©todo:

**Linha 34:** Criamos o M√©todo Ass√≠ncrono (async), chamado **login(usuarioLogin: UsuarioLogin)**.

Observe que o m√©todo **login(usuarioLogin: UsuarioLogin)** possui um par√¢metro do tipo **UsuarioLogin**, denominado **usuarioLogin**. Este par√¢metro receber√° um objeto da classe **UsuarioLogin**, que ser√° enviado no corpo da requisi√ß√£o (Request Body) de login. O objeto **usuarioLogin** ser√° enviado por um m√©todo da **classe AuthController**, que ser√° desenvolvido na parte 03 do m√≥dulo **Auth**, atrav√©s de um **JSON**, semelhante ao exemplo abaixo:

```json
{
    "usuario" : "admin@email.com.br",
    "senha" : "admin123"
}
```

Observe que todos os Atributos da Classe Auxiliar UsuarioLogin ser√£o preenchidos.

Ao receber os dados do objeto **usuarioLogin**, o **Passport** os encaminha para a classe **LocalStrategy**, que espera um objeto contendo os atributos **usuario** e **senha**. Ao receber esses dois atributos, a **LocalStrategy** ser√° respons√°vel pela autentica√ß√£o (login) do usu√°rio.

Enquanto isso, o m√©todo **login(usuarioLogin: UsuarioLogin)** ficar√° encarregado de **gerar o Token JWT**, como ser√° detalhado nas pr√≥ximas linhas.

**Linha 36:** Criamos um Objeto chamado **payload**, que ser√° utilizado na gera√ß√£o do Token JWT. Este Objeto receber√° 1 par√¢metro:

- **sub (subject):** recebe o Atributo usuario (e-mail).

Na imagem abaixo vemos a estrutura b√°sica de um Token JWT:

<div align="center"><img src="https://i.imgur.com/SXryCej.png" title="source: imgur.com" /></div>

Observe que ele √© composto pelo **Header** (cabe√ßalho), **Payload** (dados do usu√°rio, data e hora de cria√ß√£o e expira√ß√£o do Token) e a **Signature** (chave de assinatura). O Payload √© a parte customizada do Token, onde definimos as **Claims** (atributos inseridos dentro de um JSON contendo as informa√ß√µes sobre o usu√°rio), que desejamos enviar no Token JWT.

<br />

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="100px"/> | <div align="left"> **DICA:** *Caso voc√™ tenha alguma d√∫vida sobre o Token JWT, acesse o conte√∫do: <a href="14.md" target="_blank">Introdu√ß√£o a Seguran√ßa da Aplica√ß√£o</a>*.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

**Linha 38:** Criamos um objeto da classe **Usuario**, chamado **buscaUsuario**, que armazenar√° o resultado da execu√ß√£o do m√©todo **findByUsuario(usuario: Usuario)**, da classe **UsuarioService**. Esse m√©todo verifica se o usu√°rio existe. Com essa busca, recuperamos os dados do usu√°rio para inclu√≠-los na resposta da requisi√ß√£o HTTP de autentica√ß√£o bem-sucedida. Essa abordagem facilitar√° a constru√ß√£o do nosso Frontend.

**Linhas 40 a 47:** Nessas linhas, criaremos o corpo da resposta para a autentica√ß√£o bem-sucedida, no formato JSON. O objeto JSON conter√° todos os atributos encontrados na busca do objeto **Usuario**, exceto a senha e o Token, que ser√° gerado pelo m√©todo **jwtService.sign(payload)**.

Observe que o m√©todo **jwtService.sign(payload)** criar√° apenas a parte codificada do Token JWT. Por isso, a palavra **Bearer** ser√° adicionada, seguida de **um espa√ßo em branco** e da parte codificada do Token JWT. O **espa√ßo em branco entre a palavra "Bearer" e a parte codificada do Token JWT √© obrigat√≥rio!**, caso contr√°rio, o Token JWT n√£o ser√° validado.

>Um **Token Bearer** √© uma **string** utilizada para autoriza√ß√£o, que √© adicionada no cabe√ßalho de uma requisi√ß√£o HTTP, na propriedade **Authorization**.
>
>O **JWT Token** √© um dos diversos formatos de **Bearer Tokens** dispon√≠veis no mercado, sendo atualmente um dos mais utilizados.

Observe tamb√©m que a chamada do M√©todo **jwtService.sign(payload)** est√° inserida dentro de **2 acentos grave ( ` )**, utilizado na L√≠ngua Portuguesa para indicar uma crase, ao inv√©s de aspas simples ( ' ). Estes 2 acentos grave indicam que estamos criando uma **Interpola√ß√£o de strings**. Veja o trecho destacado na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/sNUXmf9.png" title="source: imgur.com" /></div>

No caso de uma autentica√ß√£o bem sucedida, o retorno esperado do M√©todo **login(usuarioLogin: UsuarioLogin)** ser√° um JSON contendo os dados do usu√°rio e o token JWT, como mostra o exemplo abaixo:

<div align="center"><img src="https://i.imgur.com/5s3cKxw.png" title="source: imgur.com" /></div>

Na imagem acima, vemos o JSON recebido no Insomnia ap√≥s a autentica√ß√£o do usu√°rio. O Token ser√° utilizado para acessar os endpoints protegidos, como veremos na parte 03 do M√≥dulo Auth.

<br />

<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/nestjs/jwt" target="_blank"><b>Documenta√ß√£o: Biblioteca NestJS - JWT</b></a></div>

<div align="left"><img src="https://i.imgur.com/RlHVydi.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/kelektiv/node.bcrypt.js#readme" target="_blank"><b>Documenta√ß√£o: Biblioteca Bcrypt JS</b></a> </div>

<div align="left"><img src="https://i.imgur.com/RlHVydi.png" title="source: imgur.com" width="25px"/> <a href="https://bcrypt-generator.com/" target="_blank"><b>Ferramenta: Bcrypt Generator</b></a> </div>

<br />

<div align="left"><img src="https://i.imgur.com/JACNZiR.png" title="source: imgur.com" width="25px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/13_Security_JWT/blogpessoal/src/auth/services/auth.service.ts" target="_blank"><b>C√≥digo fonte da Classe AuthService</b></a></div>

<br />

<h2>üë£ Passo 07 - Registrar as Classes LocalStrategy e AuthService <br /> Importar os M√≥dulos UsuarioModule, PassportModule e JwtModule na Classe AuthModule</h2>



Vamos registrar a **Classe LocalStrategy** e importar os **M√≥dulos UsuarioModule, PassportModule e JwtModule**. Veja abaixo a implementa√ß√£o da Classe **AuthModule**:

<div align="left"><img src="https://imgur.com/B8dLsfF.png" title="source: imgur.com" /></div>
<div align="left"><img src="https://i.imgur.com/Ie4jFCY.png" title="source: imgur.com" /></div>

Vamos analisar o c√≥digo:

**Linha 13:** O m√≥dulo **UsuarioModule** foi importado no array **imports**. Precisamos do m√≥dulo **UsuarioModule** para validar o usu√°rio e a senha no banco de dados durante o processo de autentica√ß√£o (login). Observe que utilizamos o m√©todo **forwardRef()** na importa√ß√£o para evitar o erro de refer√™ncia circular, pois o **UsuarioModule** depende do **AuthModule** e vice-versa.

**Linha 14:** O m√≥dulo **PassportModule** foi importado no array **imports**. Precisamos desse m√≥dulo para implementar o pacote **Passport** e suas **Strategies**.

**Linha 15:** O m√≥dulo **JwtModule** foi importado no array **imports**. Precisamos do **JwtModule** para criar o Token JWT. Al√©m de importar o m√≥dulo, √© necess√°rio executar o m√©todo **register()** para configurar algumas propriedades dentro do m√≥dulo.

**Linha 16:** Configura a propriedade **secret** (chave de assinatura do token JWT) com o valor da propriedade **secret da constante jwtConstants**.

**Linha 17:** Configura a propriedade **signOptions** (op√ß√µes do processo de cria√ß√£o do token). Observe que dentro dessa propriedade h√° um objeto com as configura√ß√µes espec√≠ficas do m√©todo **sign()** da **Classe JwtService** do **M√≥dulo JwtModule**. Vamos configurar a propriedade **expiresIn** (tempo de validade do Token JWT) com o valor **1h**. O token gerado ter√° validade de 1 hora; ap√≥s esse per√≠odo, ser√° necess√°rio gerar um novo.

Veja o exemplo na imagem abaixo:

<div align="center"><img src="https://imgur.com/1yE6xcc.png" title="source: imgur.com" /></div>

De volta ao **Debugger do JWT**, se mantivermos o Mouse sobre o item **iat** do **payload**, ser√° exibida a data, a hora e o fuso hor√°rio em que o token foi gerado. Se mantivermos o Mouse sobre o item **exp** do **payload**, ser√° exibida a data, a hora e o fuso hor√°rio em que o token vai expirar. Observe que d√° **exatamente 1 hora**, conforme configuramos na propriedade **expiresIn**.

> **iat (issued at)**: Identifica quando o Token JWT foi criado.
>
> **exp (expiration time)**: Identifica o tempo de expira√ß√£o do Token JWT.

**Linha 19:** Vamos adicionar as Classes **AuthService e LocalStrategy ** no array **providers**, por se tratarem de Classes de Servi√ßo, respons√°veis por gerar o token JWT e autenticar o usu√°rio respectivamente.

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao registrar Classes e M√≥dulos. Observe que ap√≥s registro, novas importa√ß√µes ser√£o necess√°rias nas primeiras linhas da Classe M√≥dulo.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/oScAYGc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **ATEN√á√ÉO:** *Se uma Classe for importada com o caminho absoluto (src/bcrypt/bcrypt), os testes da aplica√ß√£o com o framework Jest n√£o ser√£o executados. O Jest n√£o reconhece caminho absoluto, apenas caminho relativo (./bcrypt/bcrypt)* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="35px"/> <a href="https://www.rfc-editor.org/rfc/rfc7519#section-4.1" target="_blank"><b>Documenta√ß√£o: RFC7519 - Padroniza√ß√£o do JSON WEB Token</b></a></div>

<div align="left"><img src="https://i.imgur.com/WeNdbPo.png" title="source: imgur.com" width="35px"/> <a href="https://jwt.io/introduction" target="_blank"><b>Documenta√ß√£o: JWT - JSON WEB Token</b></a></div>

<div align="left"><img src="https://i.imgur.com/WeNdbPo.png" title="source: imgur.com" width="35px"/> <a href="https://jwt.io/" target="_blank"><b>Ferramenta: JWT Debugger</b></a></div>

<br />

Na parte 03 vamos finalizar a implementa√ß√£o do M√≥dulo Auth e faremos os testes no Insomnia...

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
